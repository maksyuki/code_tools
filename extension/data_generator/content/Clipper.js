/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

define(["GlobalUtils","PageInfo"],function(a,b){function c(a,c,d){function e(b){k+=b,j<i.length?n(i[j++],null,a,e,null,d):c(k)}function f(b){g=b,l(g),n(g,null,a,e,null,d,h)}var g,h={isOutlookMail:b.isOutlookMail()},i=b.getNextPages(),j=1,k="";try{if(g=contentPreview.getArticleElement())return l(g),void n(g,null,a,e,null,d,h)}catch(a){log.warn("Couldn't get preview from contentPreview. Trying pageInfo.")}try{return void b.getDefaultArticle(f)}catch(a){log.warn("Couldn't get article from pageInfo. Trying default.")}g=document.body,l(g),n(g,null,a,e,null,d,h)}function d(a,b,c){l(document.body),n(document.body,null,a,b,null,c)}function e(c){c('<embed src="'+a.escapeXML(b.getPdfUrl())+'" type="application/pdf"></embed>')}function f(a,b){var c=contentPreview.getEmailElement();l(c),n(c,null,!0,a,null,b,{isEmailClip:!0})}function g(a,b,c,d){if(b&&document.querySelector("embed[type='application/pdf']"))return void c(b);var e;try{e=contentPreview.ensureSelectionIsShown(),e&&(v=[],m(e,0,c,d))}catch(a){c("")}}function h(b,c){var d=document.querySelector("img[src='"+b+"'], img[src$='"+b.replace(document.body.baseURI,"")+"']"),e=u.convertImgSrcToBase64IfPossible(d,b,!0);e===b&&(e=a.escapeXML(e)),c('<img src="'+e+'"></img>')}function i(a){var b=contentPreview.getUrlElement(function(b){a(b)});b&&a(b)}function j(a,b){l(document.body);for(var c=contentPreview.getClearlyReformat(),d=c.$iframePages[0].getElementsByTagName("span"),e=0;e<d.length;e++)d.item(e).parentNode.removeChild(d.item(e));l(c.$iframePages[0]),n(c.$iframePages[0],null,!1,a,c.iframe.contentWindow,b)}function k(a,b){var c=contentPreview.getCustomElementContent();n(c,null,!1,a,c.ownerDocument.defaultView,b)}function l(a){for(var b=a.querySelectorAll("a.clearly_highlight_delete_element"),c=0;c<b.length;c++)b.item(c).parentNode.removeChild(b.item(c));for(var d=a.querySelectorAll("em.clearly_highlight_element"),c=0;c<d.length;c++)d.item(c).outerHTML="<highlight>"+d.item(c).innerHTML+"</highlight>"}function m(a,b,c,d){new Promise(function(c,e){if(a.getRangeAt(b).commonAncestorContainer.nodeType==Node.TEXT_NODE){c(o(a.getRangeAt(b).commonAncestorContainer.textContent.substring(a.getRangeAt(b).startOffset,a.getRangeAt(b).endOffset)))}else l(a.getRangeAt(b).commonAncestorContainer),n(a.getRangeAt(b).commonAncestorContainer,a.getRangeAt(b),!0,c,null,d)}).then(function(d){v.push(d),b<a.rangeCount-1?m(a,++b,c):c(v.join(" "))})}function n(a,c,d,e,f,g,h){function i(a,b){b?g(b):s(a)}function j(a){u.serialize(p,q,r,i,a,null,h)}if(p=a,q=c,r=d,s=e,f)u.serialize(p,q,r,i,null,f);else try{h||(h={}),h.isOutlookMail=b.isOutlookMail(),serializeFrames(j,h)}catch(a){g(a)}}function o(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;")}var p,q,r,s,t={},u=new HtmlSerializer,v=[];return t.clipArticle=c,t.clipEmail=f,t.clipImage=h,t.clipFullPage=d,t.clipPdf=e,t.clipSelection=g,t.clipUrl=i,t.clipClearly=j,t.clipCustom=k,t});