/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function NotebookSelector(a){"use strict";function b(){return aa.value.trim()}function c(){var a=b();if(a)if(EDGE&&document.activeElement.blur(),ea.disabled=!0,h(!0),d(a))i(Browser.i18n.getMessage("Error_Create_Notebook_ExistingName"));else{var c={name:a};"function"==typeof I&&I(c)}}function d(a){for(var b=a.toLowerCase(),c=0;c<fa.length;c++){var d=fa[c];if(b===d.name.toLowerCase()&&(!d.type||d.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL||d.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&!d.owner))return!0}return!1}function e(){aa.placeholder=Browser.i18n.getMessage("createNewNotebook"),ba.classList.add("hide"),aa.value="",ea.disabled=!1,j()}function f(){ba.classList.contains("hide")&&(Browser.sendToExtension({name:"trackEvent",category:"notebooks",action:"add_notebook"}),aa.placeholder=Browser.i18n.getMessage("enterName"),ba.classList.remove("hide"),"function"==typeof setHeight&&setHeight())}function g(a){log.log("Refresh notebooks list"),h(!0),"function"==typeof H&&H()}function h(a){a?(M.classList.add("nbLoading"),$.classList.add("rotating")):(M.classList.remove("nbLoading"),$.classList.remove("rotating"))}function i(a){h(!1),W.classList.remove("hide"),X.innerText=a,"function"==typeof setHeight&&setHeight()}function j(){W.classList.add("hide"),"function"==typeof setHeight&&setHeight()}function k(a){fa.push(a),l(fa)}function l(a){if(h(!1),fa=a,z(),fa&&fa.length>0){var b;fa.forEach(function(a){n(a),a.defaultNotebook&&(b=a.guid)},this),m(b||fa[0].guid)}else i(Browser.i18n.getMessage("Error_No_Notebooks")),B();"function"==typeof setHeight&&setHeight()}function m(a){if(a){var b=Q.querySelector('.nbNotebook[guid="'+a+'"]');b&&B(b)}else log.warn("Tried to select notebook without guid: "+JSON.stringify(a))}function n(a){var b=document.createElement("div");b.classList.add("nbNotebook");var c=document.createElement("span");c.innerText=a.name;for(var d=a.name.split(/\s+/),e=0;e<d.length;e++)K.insert(d[e],b),CommonSelector.SPECIAL_CHAR_REGEX.test(d[e])&&K.insert(d[e].replace(CommonSelector.SPECIAL_CHAR_REGEX,""),b);if(b.appendChild(c),a.owner){var f=document.createElement("span");f.classList.add("nbNotebookOwner"),f.innerText=" ("+a.owner+")",b.appendChild(f)}return a.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?(b.classList.add("nbLinkedNotebook"),b.setAttribute("globalId",a.globalId),b.setAttribute("shardId",a.shardId),a.noteStoreUrl&&b.setAttribute("noteStoreUrl",encodeURIComponent(a.noteStoreUrl))):a.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&b.classList.add("nbBusinessNotebook"),D(b),w(b)||b.classList.add("nbHidden"),a.noShareNotes&&b.setAttribute("noShareNotes",""),b.addEventListener("click",function(){B(this),ga.userSelectedNotebookGuid=this.getAttribute("guid"),"function"==typeof J&&J(),C()}),b.addEventListener("mouseover",function(){for(var a=Q.querySelectorAll(".nbHover"),b=0;b<a.length;b++)a[b].classList.remove("nbHover");this.classList.add("nbHover")}),b.title=b.innerText,b.setAttribute("guid",a.guid),a.defaultNotebook&&b.setAttribute("default",""),v(b,a.stack),b}function o(a){var b=document.createElement("div");b.classList.add("nbStack");var c=document.createElement("h3");return c.innerText=a,c.title=c.innerText,b.appendChild(c),v(b),b}function p(a,b,c,d,e){for(var f=e-1,g=a.toLowerCase();d<=f;){for(var h=d+Math.floor((f-d)/2),i=c[h],j=0;j<(b?b.length:0);j++)i=i[b[j]];if(g<i.innerText.toLowerCase())f=h-1;else{if(!(g>i.innerText.toLowerCase()))return h;d=h+1}}return-1}function q(){return F.classList.contains("nbOpen")}function r(){var a=F.classList.contains("nbOpen");return F.classList.remove("nbOpen"),P.value="",A(),"function"==typeof G&&G(),a}function s(a){return F.contains(a)}function t(){var a=GlobalUtils.NOTEBOOK_TYPE_PERSONAL;return M.classList.contains("nbSelectedLinked")?a=GlobalUtils.NOTEBOOK_TYPE_LINKED:M.classList.contains("nbSelectedBusiness")&&(a=GlobalUtils.NOTEBOOK_TYPE_BUSINESS),{defaultNotebook:M.hasAttribute("default"),globalId:M.getAttribute("globalId"),guid:M.getAttribute("guid"),name:M.innerText,noteStoreUrl:M.getAttribute("noteStoreUrl"),noShareNotes:M.hasAttribute("noShareNotes"),shardId:M.getAttribute("shardId"),type:a}}function u(a){if(13===a.keyCode){var b=Q.querySelector(".nbHover");b&&(B(b),ga.userSelectedNotebookGuid=b.getAttribute("guid"),C())}}function v(a,b){function c(a){return a.classList.contains("nbStack")?a.firstElementChild.innerText:a.classList.contains("nbNotebook")?a.innerText:void 0}var d=Q;if(b){var e=Q.querySelectorAll(".nbStack");d=e[p(b,["firstElementChild"],e,0,e.length)]||Q,d===Q&&(d=o(b))}b?CommonSelector.binaryInsert(d,c,a,1):CommonSelector.binaryInsert(d,c,a)}function w(a){for(var b=0;b<L.length;b++)if(L[b].indexOf(a)<0)return!1;return!0}function x(a){function b(a,c){var d=a[c];return d&&d.classList.contains("nbStack")?d="nextElementSibling"===c?d.children[1]:d.lastElementChild:d&&d.parentNode.classList.contains("nbStack")&&d===d.parentNode.children[0]?d=b(d.parentNode,c):!d&&a.parentNode.classList.contains("nbStack")&&(d=b(a.parentNode,c)),d}if(38===a.keyCode||40===a.keyCode){var c=38===a.keyCode?"previousElementSibling":"nextElementSibling",d=Q.querySelector(".nbHover")||E;if(d){for(var e=b(d,c);e&&e.classList.contains("nbHidden");)e=b(e,c);e&&!e.classList.contains("nbHidden")&&(d.classList.remove("nbHover"),e.classList.add("nbHover"),e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded():e.scrollIntoView())}a.preventDefault()}}function y(){F.classList.add("nbOpen"),P.focus(),setTimeout(function(){E&&(E.scrollIntoViewIfNeeded?E.scrollIntoViewIfNeeded():E.scrollIntoView())},50),"function"==typeof G&&G()}function z(){E=null,K=new Tree,L=[],P.value="",Q.innerHTML="",j()}function A(){for(var a=Q.querySelectorAll(".nbNotebook.nbHover"),b=0;b<a.length;b++)a[b].classList.remove("nbHover");var c=P.value.trim();if(c){c=c.split(/\s+/),L=[];for(var b=0;b<c.length;b++){for(var d=K.getMatching(c[b]),e=[],f=0;f<d.length;f++)e=e.concat(d[f][1]);L.push(e)}for(var g=Q.querySelectorAll(".nbNotebook"),b=0;b<g.length;b++)w(g[b])?g[b].classList.remove("nbHidden"):g[b].classList.add("nbHidden");Q.classList.add("nbSearchOn");var h=Q.querySelector(".nbNotebook:not(.nbHidden)");h&&h.classList.add("nbHover")}else{for(var i=Q.querySelectorAll(".nbHidden"),b=0;b<i.length;b++)i[b].classList.remove("nbHidden");Q.classList.remove("nbSearchOn")}}function B(a){E&&E.classList.remove("nbSelectedNotebook"),a?(a.classList.add("nbSelectedNotebook"),E=a,M.innerText=a.innerText,M.title=M.innerText,M.setAttribute("guid",E.getAttribute("guid")),E.classList.contains("nbBusinessNotebook")?(M.classList.remove("nbSelectedLinked"),M.classList.add("nbSelectedBusiness"),M.removeAttribute("globalId"),M.removeAttribute("shardId"),M.removeAttribute("noteStoreUrl")):E.classList.contains("nbLinkedNotebook")?(M.classList.remove("nbSelectedBusiness"),M.classList.add("nbSelectedLinked"),M.setAttribute("globalId",E.getAttribute("globalId")),M.setAttribute("shardId",E.getAttribute("shardId")),M.setAttribute("noteStoreUrl",E.getAttribute("noteStoreUrl"))):(M.classList.remove("nbSelectedBusiness"),M.classList.remove("nbSelectedLinked"),M.removeAttribute("globalId"),M.removeAttribute("shardId"),M.removeAttribute("noteStoreUrl")),E.hasAttribute("noShareNotes")?M.setAttribute("noShareNotes",""):M.removeAttribute("noShareNotes"),E.hasAttribute("default")?M.setAttribute("default",""):M.removeAttribute("default")):(M.innerText="----           ",M.setAttribute("guid",""))}function C(){F.classList.contains("nbOpen")?(e(),r()):y(),"function"==typeof setHeight&&setHeight(!0)}function D(a){var b=P.value.trim();if(b){b=b.split(/\s+/);for(var c=0;c<b.length;c++)new RegExp("(?:\\s|^)"+b[c],"i").test(a.firstElementChild.innerText)&&(L[c]||L.push([]),L[c].push(a))}}var E,F=a.container,G=a.dropdownToggleCallback,H=a.refreshNotebooksCallback,I=a.createNotebookCallback,J=a.selectNotebookCallback,K=new Tree,L=[],M=document.createElement("div"),N=document.createElement("div"),O=document.createElement("div"),P=document.createElement("input"),Q=document.createElement("div"),R=document.createElement("div"),S=document.createElement("div"),T=document.createElement("hr"),U=document.createElement("span"),V=document.createElement("span"),W=document.createElement("div"),X=document.createElement("div"),Y=document.createElement("div"),Z=document.createElement("span"),$=document.createElement("div"),_=document.createElement("div"),aa=document.createElement("input"),ba=document.createElement("div"),ca=document.createElement("div"),da=document.createElement("button"),ea=document.createElement("button"),fa=[],ga={userSelectedNotebookGuid:null,optionSelectedNotebookGuid:null};F.classList.add("nbContainer"),M.classList.add("nbSelected"),N.classList.add("nbDropdown"),P.classList.add("nbSearchInput"),S.classList.add("nbRefreshNotebooksInfoBlock"),T.classList.add("nbRefreshNotebooksLine"),U.classList.add("nbRefreshNotebooksInfo"),W.classList.add("nbGlobalErrorBlock"),W.classList.add("hide"),X.classList.add("globalErrorBlockInfo"),$.classList.add("nbRefreshNotebooksInfoBlockIcon"),$.classList.add("useSvg"),V.classList.add("nbRefreshNotebooksRefresh"),Y.classList.add("notebooksErrorBlock"),Y.classList.add("hide"),Q.classList.add("nbList"),R.classList.add("nbInputFocuser"),_.classList.add("nbAddNotebookBlock"),aa.classList.add("nbCreateNewNotebookInput"),aa.classList.add("useSvg"),aa.placeholder=Browser.i18n.getMessage("createNewNotebook"),ba.classList.add("nbCreateNewNotebookElementsBlock"),ba.classList.add("hide"),ca.classList.add("nbCreateNewNotebookButtons"),da.classList.add("nbCreateNewNotebookCancelButton"),ea.classList.add("nbCreateNewNotebookCreateButton"),P.placeholder=Browser.i18n.getMessage("findANotebook"),P.tabIndex=2,R.tabIndex=1,U.innerHTML=Browser.i18n.getMessage("cantFindIt"),V.innerHTML=Browser.i18n.getMessage("refreshList"),S.appendChild(T),S.appendChild(U),S.appendChild($),S.appendChild(V),W.appendChild(X),Y.appendChild(Z),da.innerHTML=Browser.i18n.getMessage("regForm_cancel"),ea.innerHTML=Browser.i18n.getMessage("create"),F.appendChild(W),F.appendChild(M),O.appendChild(P),O.appendChild(Y),O.appendChild(_),_.appendChild(aa),_.appendChild(ba),ba.appendChild(ca),ca.appendChild(da),ca.appendChild(ea),N.appendChild(O),N.appendChild(Q),N.appendChild(S),F.appendChild(N),F.appendChild(R),V.addEventListener("click",function(a){a.stopPropagation(),Browser.sendToExtension({name:"trackEvent",category:"notebooks",action:"refresh"}),g(),P.focus()}),W.addEventListener("click",function(a){a.stopPropagation(),W.classList.add("hide"),g(),P.focus()}),aa.addEventListener("focus",function(a){a.stopPropagation(),f()}),aa.addEventListener("click",function(a){a.stopPropagation()}),aa.addEventListener("keyup",function(a){a.stopPropagation(),a.preventDefault(),13===a.keyCode&&c()}),da.addEventListener("click",function(a){a.stopPropagation(),e()}),ea.addEventListener("click",function(a){c(),a.stopPropagation()}),M.addEventListener("click",function(a){C(),a.stopPropagation()}),P.addEventListener("click",function(a){a.stopPropagation(),e()}),P.addEventListener("input",function(){A(),"function"==typeof setHeight&&setHeight()}),P.addEventListener("keydown",x),P.addEventListener("keyup",u),R.addEventListener("focus",y),Q.addEventListener("mousewheel",Browser.overrideScroll,!0),h(!0),this.getCreateNewNotebookValue=b,this.setNotebooks=l,this.appendNotebook=k,this.saveNewNotebook=c,this.close=r,this.contains=s,this.getSelectedNotebook=t,this.selectNotebook=m,this.open=y,this.reset=z,this.setLoadingStatus=h,this.select=B,this.isOpened=q,this.showError=i,this.closeNewNotebookBlock=e,this.selectionData=ga,this.__defineGetter__("height",function(){return N.offsetTop+N.offsetHeight}),Object.preventExtensions(this)}Object.preventExtensions(NotebookSelector);