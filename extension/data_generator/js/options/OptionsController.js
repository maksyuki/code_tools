/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function OptionsController(){"use strict";function a(){var a={};for(var b in I)I[b].forEach(function(b){a[b]=!1});Browser.sendToExtension({name:"main_getConfig",options:a,returnName:"options_config",toOwnWindow:C})}function b(){document.body.classList.toggle("loggedIn",!!M.userId),accountSelector&&(document.getElementById("username").textContent=accountSelector.getSelectedAccount().userInfo.email||"?",document.getElementById("options_showSaveToEvernote").style.display=N?"":"none"),a()}function c(a){accountSelector=new AccountSelector({globalContainer:document.querySelector("#main"),fieldContainer:document.querySelector("#accountSelector"),signInCallback:function(a,b,c){platform.channel.sendMessage("openSignIn",{userId:a,subpart:b,businessSSO:c}).then(function(c){c.success?(accountSelector.updateAccountTier(a,c.userInfo),accountSelector.selectItem({selectedAccountId:a,selectedSubpart:b}),Browser.sendToExtension({name:"bounceToAll",message:{name:"gt_refresh"},toOwnWindow:C})):accountSelector.selectFirstLoggedIn()})},changeCallback:function(a,c){s(),platform.channel.sendMessage("setSelectedAccount",{selectedAccount:a,selectedSubpart:c}).then(function(){b()})}.bind(this)}),accountSelector.setData(a.list);var c=Object.keys(a.list);c.length<2&&a.list[c[0]].accountType!=GlobalUtils.ACCOUNT_TYPE_BUSINESS&&accountSelector.hideDropdown(),accountSelector.selectItem({selectedAccountId:a.selectedAccount,selectedSubpart:a.selectedSubpart})}function d(a){defaultAccountSelector=new AccountSelector({globalContainer:document.querySelector("#main"),fieldContainer:document.querySelector("#defaultAccount"),dropdownID:"defaultAccountDropdown"}),defaultAccountSelector.setData(a.list);var b=Object.keys(a.list);b.length<2&&a.list[b[0]].accountType!=GlobalUtils.ACCOUNT_TYPE_BUSINESS&&(document.querySelector("#defaultClipping").style.display="none"),H=defaultAccountSelector.addOption({id:"defaultAccount",header:chrome.i18n.getMessage("Last_used"),description:"",isSelectable:!0,callback:j,value:"last"}),defaultAccountSelector.updateModel({changeCallback:function(a,b){var c={defaultAccount:{id:a,subpart:b}};Browser.sendToExtension({name:"main_setOption",options:c})}})}function e(){""===document.querySelector("#startNotebook").innerHTML&&(notebookSelector=new NotebookSelector({container:document.querySelector("#startNotebook"),selectNotebookCallback:h,refreshNotebooksCallback:function(){f(!1)}}))}function f(a){var b=accountSelector.getSelectedAccount();platform.channel.sendMessage("getNotebooks",{userId:b.userInfo.userId,selectedSubpart:b.selectedSubpart,cached:a}).then(function(a){if(a){var c=b.selectedSubpart===GlobalUtils.ACCOUNT_TYPE_PERSONAL?a.personal:a.business;(b.selectedSubpart===GlobalUtils.ACCOUNT_TYPE_PERSONAL||b.userInfo.isOnlyBusiness)&&(c=c.concat(a.linked)),notebookSelector.setNotebooks(c),void 0!==G&&G&&notebookSelector.selectNotebook(G)}}).catch(function(a){return log.error("Could not get notebooks "+a.msg),null})}function g(a,b,c){q(),a.options&&(i(a),GlobalUtils.localize(document.body),GlobalUtils.localize(document.getElementsByTagName("title")[0]),l(a),u(),f(!0),c&&"function"==typeof c&&c())}function h(){r();var a={};a.startNotebook=notebookSelector.getSelectedNotebook().guid,document.getElementById("alwaysStartInNotebook").click(),Browser.sendToExtension({name:"main_setOption",options:a})}function i(a){for(var b in I)switch(b){case"checkboxValues":I[b].forEach(function(b){var c=b,d=document.getElementById(c);d.checked=a.options[c],"enableKeyboardShortcuts"==c&&(d.checked||document.getElementById("shortcutsContainer").classList.add("disabled")),d.addEventListener("change",m)});break;case"selectValues":I[b].forEach(function(b){var c=b,d=document.getElementById(c);if("startNotebook"===c)M.userId&&(G=a.options[c]);else if("defaultAccount"===c){if(M.userId){var e=a.options[c];e.id?defaultAccountSelector.selectItem({selectedAccountId:e.id,selectedSubpart:e.subpart}):defaultAccountSelector.selectItem({id:"defaultAccount"})}}else for(var f=a.options[c],g=0;g<d.options.length;g++)if(d.options[g].value==f){d.selectedIndex=g;break}d.addEventListener("change",n)});break;case"textValues":I[b].forEach(function(b){var c=b,d=document.getElementById(c);d.value=a.options[c],d.addEventListener("change",o)});break;case"radioValues":I[b].forEach(function(b){for(var c=b,d=document.getElementsByName(c),e=0;e<d.length;e++)d.item(e).value==a.options[c]&&(d.item(e).checked=!0),d.item(e).addEventListener("change",p)})}}function j(a){var b={};b[a.id]=a.value,Browser.sendToExtension({name:"main_setOption",options:b})}function k(a,b,c){var d=[],e=[],f=[];for(var g in a.options)a.options[g]!==J[g]&&(d.push(J[g]),e.push(a.options[g]),f.push(g));l(a),Browser.sendToExtension({name:"bounceToAll",message:{name:"updateKeyboardShortcut",oldShortcut:d,shortcut:e,shortcutName:f},toOwnWindow:C}),c&&"function"==typeof c&&c()}function l(a){J={},K={},L={},I.shortcutValues.forEach(function(b){var c=b,d=document.getElementById(c);J[c]=a.options[c],K[a.options[c]]=c;var e=new ShortcutSetter(d,a.options[c],"optionsPage",function(a,b){var c=a.id;if(K[b])return K[b]!=c&&(D=L[K[b]],D.showConflict(),{conflict:!0});if(/(\||^)27(\||$)/.test(b)&&"closeWebClipperShortcut"!==c)return{noEsc:!0};r();var d={};return d[c]=b,Browser.sendToExtension({name:"main_setOption",options:d}),Browser.sendToExtension({name:"bounceToAll",message:{name:"updateKeyboardShortcut",oldShortcut:J[c],shortcut:b,shortcutName:c},toOwnWindow:C}),delete K[J[c]],K[b]=c,J[c]=b,!1},function(){return!!A||(A=!0,!1)},function(){D&&(D.removeConflict(),D=null)},function(){return document.getElementById("shortcutsContainer").classList.contains("disabled")},function(a){return F[a]});L[c]=e})}function m(a){var b=this.id;if(b){r();var c={};c[b]=this.checked,"enableKeyboardShortcuts"==b&&(this.checked?document.getElementById("shortcutsContainer").classList.remove("disabled"):document.getElementById("shortcutsContainer").classList.add("disabled"),Browser.sendToExtension({name:"bounceToAll",message:{name:"receiveKeyboardShortcutsEnabled",keyboardShortcutsEnabled:this.checked}})),Browser.sendToExtension({name:"main_setOption",options:c})}u()}function n(a){var b=this.id;if(b){r();var c={};c[b]=this.options[this.selectedIndex].value,Browser.sendToExtension({name:"main_setOption",options:c})}u()}function o(a){var b=this.id;if(b){r();var c={};c[b]=this.value,Browser.sendToExtension({name:"main_setOption",options:c})}u()}function p(){var a=this.name;if(a){r();var b={};b[a]=this.value,Browser.sendToExtension({name:"main_setOption",options:b}),"notebookSelection"==a&&"alwaysStartIn"===this.value&&h()}u()}function q(){document.querySelector("#savingContainer").className="invisible"}function r(){document.querySelector("#loadingMessage").textContent=chrome.i18n.getMessage("options_saving"),window.setTimeout(function(){document.querySelector("#savingContainer").className="invisible"},500),document.querySelector("#savingContainer").className="visible"}function s(){document.querySelector("#loadingMessage").textContent=chrome.i18n.getMessage("loading"),document.querySelector("#savingContainer").className="visible"}function t(a){var b=document.getElementById("developerContainer").style;void 0===a&&(a="none"===b.display),b.display=a?"table-row-group":"none",u()}function u(){var a,b=document.querySelector(".pinch");b.classList.contains("shortcuts")&&(a=document.querySelector("#shortcutsContainer")),b.classList.contains("options")&&(a=document.querySelector("#optionsContainer")),b.classList.contains("legal")&&(a=document.querySelector("#legalContainer")),b.style.height="";var c=a.scrollHeight;b.style.height=a.scrollHeight+"px",Browser.sendToExtension({name:"bounce",message:{name:"setOptionsHeight",height:z+c},toOwnWindow:C})}function v(a,b){B&&["INPUT","TEXTAREA"].indexOf(b.nodeName)<0&&"true"!==b.contentEditable&&Browser.sendToExtension({name:"bounce",message:{name:"duplicateKeyboardShortcut",keycode:a},toOwnWindow:C})}function w(a,b){["INPUT","TEXTAREA"].indexOf(b.nodeName)<0&&"true"!==b.contentEditable&&Browser.sendToExtension({name:"bounce",message:{name:"duplicateKeyboardShortcut",keycode:a},toOwnWindow:C})}function x(a,b,c){if(B=a.enabled,a.handlers){var d={};for(var e in a.handlers)for(var f=0;f<a.handlers[e].length;f++)d[a.handlers[e][f]]="closeWebClipperShortcut"===e?w:v;Browser.addKeyboardHandlers(d)}c&&"function"==typeof c&&c()}function y(a,b,c){document.getElementsByClassName("pinch")[0].style.height=a.totalHeight-z+"px",c&&"function"==typeof c&&c()}var z=300,A=!1,B=!0;this.reset=function(a){a.preventDefault(),a.stopPropagation(),!0===confirm("Warning. This action will delete all persistent clipper data on this browser.")&&(r(),Persistent.clearAll(),log.log("Cleaned all local storage"),Browser.sendToExtension({name:"clearPersistent"}),Browser.sendToExtension({name:"main_clearOptions",options:I,type:"all"}),Browser.sendToExtension({name:"LOGOUT",restart:!0}))};var C=!0;this.separateTab=function(a){return void 0!==a&&(C=a),C},/iframe/.test(document.location.hash)&&(C=!1),window.addEventListener("DOMContentLoaded",function(){window.addEventListener("click",function(a){Compatibility.openTab(a)}),document.querySelector("#main").addEventListener("click",function(a){notebookSelector&&notebookSelector.isOpened()&&notebookSelector.close()}),document.getElementById("signOut").addEventListener("click",function(){Browser.sendToExtension({name:"LogoutUser",userId:accountSelector.getSelectedAccount().userInfo.userId},function(){/newui/.test(document.location.hash)&&document.location.reload()}),Browser.sendToExtension({name:"trackEvent",category:"Account",action:"sign_out",endSession:!0})}),document.getElementById("resetShortcuts").addEventListener("click",function(){r(),Browser.sendToExtension({name:"main_clearOptions",options:I,type:"shortcutValues"})}),document.getElementById("done").addEventListener("click",function(){Browser.sendToExtension({name:"bounce",message:{name:"hideOptions",closeClipper:!M},toOwnWindow:C})}),EDGE&&document.getElementById("main").classList.add("isEdge"),Promise.all([platform.channel.sendMessage("getPersistentValue",{key:"charCodeCache"}),platform.channel.sendMessage("isExperimentActive",{name:"imageExperiment"}),platform.channel.sendMessage("getPersistentValue",{key:"devOptionsEnabled"}),platform.channel.sendMessage("getCurrentAccount")]).then(function(a){F=a[0]||{},M=a[3].userInfo||{},N=a[1]&&M.userId,t(!!a[2]),platform.channel.sendMessage("setPersistentValue",{key:"devOptionsEnabled",value:!1}),platform.channel.sendMessage("getAccountsData").then(function(a){Object.keys(a.list).length?(c(a),d(a),e(),f(!0)):b()})}).catch(function(a){log.error(a),M={},N=!1,b()})}),Browser.addMessageHandlers({options_config:g,optionsShortcutCleared:k,op_setKeyboardHandlers:x,op_setPinchHeight:y});var D,E,F,G,H,I={checkboxValues:["smartFilingTags","alwaysTagWith","useSearchHelper","enablePdfPageButton","saveToEvernote","simulateSimplifiedChinese","useStage","enableKeyboardShortcuts"],selectValues:["startNotebook","clipAction","defaultAccount"],textValues:["alwaysTags","insecureProto","secureProto","overrideServiceURL"],radioValues:["notebookSelection","defaultClipAction","afterClip","simulateClippingError"],shortcutValues:["startWebClipperShortcut","closeWebClipperShortcut","previewArticleShortcut","previewFullPageShortcut","previewUrlShortcut","selectionModeShortcut","takeScreenshotShortcut","clearlyShortcut","pdfShortcut","emailShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut","toggleAccountShortcut","selectNotebookShortcut","addTagsShortcut","saveShortcut","minimizeClipperShortcut","selectAllMarkupShortcut","arrowShortcut","textShortcut","rectangleShortcut","roundedRectangleShortcut","ellipseShortcut","lineShortcut","markerShortcut","highlighterShortcut","stampShortcut","pixelateShortcut","cropShortcut","zoomInShortcut","zoomOutShortcut","zoomToFitShortcut","zoomToOriginalShortcut","undoShortcut","redoShortcut"]},J={},K={},L={},M={},N=!1;window.addEventListener("keydown",function(a){F&&(a.keyCode<65||a.keyCode>90)&&(E=a.keyCode)},!0),window.addEventListener("keypress",function(a){F&&E&&(E!=a.charCode&&(F[E]=a.charCode,Browser.sendToExtension({name:"setPersistentValue",key:"charCodeCache",value:F})),E=null)}),(new Konami).addCode(Konami.Code.Batman,t),Object.preventExtensions(this)}var accountSelector,notebookSelector,defaultAccountSelector;Object.preventExtensions(OptionsController);var optionsController=new OptionsController;window.addEventListener("DOMContentLoaded",function(){function a(a,b,c){if(a.bootstrapInfo&&a.bootstrapInfo.name){a.bootstrapInfo.name.match(/china/i)&&document.body.classList.add("china");var d="https://"+a.bootstrapInfo.serviceHost;document.getElementById("copyright").innerHTML=Browser.i18n.getMessage("copyright",[(new Date).getFullYear().toString(),d])+' | <a href="" id="resetAllOptionsFooter" message="options_resetAllOptions">'+Browser.i18n.getMessage("options_resetAllOptions")+"</a>",document.getElementById("resetAllOptions").addEventListener("click",optionsController.reset),document.getElementById("resetAllOptionsFooter").addEventListener("click",optionsController.reset),document.getElementById("logDescription").innerHTML=Browser.i18n.getMessage("options_eventLogDescription",[d+"/privacy"]);for(var e=document.getElementsByClassName("tab"),f=0;f<e.length;f++)e.item(f).addEventListener("click",function(){var a=document.querySelector(".tab.pressed");a&&(a.className=a.className.replace(/\s*pressed/g,""));var b=document.querySelector(".pinch");b.className=b.className.replace(/\s*(options|shortcuts|legal)/g,""),this.className+=" pressed","optionsTab"==this.id?b.className+=" options":"shortcutsTab"==this.id?b.className+=" shortcuts":"legalTab"==this.id&&(b.className+=" legal")});/shortcuts/.test(document.location.hash)&&document.getElementById("shortcutsTab").click(),c&&"function"==typeof c&&c()}}SAFARI&&document.body.classList.add("safari"),/iframe/.test(document.location.hash)&&window!=top&&document.body.classList.add("iframe"),/newui/.test(document.location.hash)&&(document.body.classList.add("iframe"),document.body.classList.add("newui")),Browser.addMessageHandlers({options_bconfig:a}),Browser.sendToExtension({name:"main_getConfig",bootstrapInfo:{name:null,serviceHost:null},toOwnWindow:optionsController.separateTab(),returnName:"options_bconfig"}),platform.channel.sendMessage("getPersistentValue",{key:"EVERNOTE_VERSION"}).then(function(a){document.getElementById("version").innerText=a+" ("+BUILD_VERSION+"/"+SKITCH_BUILD_VERSION+")"})}),window.addEventListener("error",function(a){log.error(JSON.stringify(a))});