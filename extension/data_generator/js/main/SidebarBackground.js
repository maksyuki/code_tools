/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

define(["GlobalUtils","isTest"],function(a,b){"use strict";function c(a,b){return a&&b&&!/\/u\/\d+\//.test(a)?a.replace(/(shard\/[^\/]*)/i,"$1/u/"+b):a}function d(b,c,d){d=d||a.ACCOUNT_TYPE_PERSONAL;var e,f,g,h={};return new Promise(function(i,j){function k(c,k){if(c){if(c.debugInfo&&delete c.debugInfo,"smartFiling"===options.get("notebookSelection")&&c.notebook&&(h.smartNotebook=c.notebook),options.get("smartFilingTags")&&c.tags&&(h.smartTags=[],c.tags.list.forEach(function(a){h.smartTags.push(a.name)})),b.pendingNoteKey){if(g.relatedNotes||(g.relatedNotes={}),g.relatedNotes=c&&c.relatedNotes?c.relatedNotes.list:[],d===a.ACCOUNT_TYPE_BUSINESS&&c.containingNotebooks&&c.containingNotebooks.list.length){for(var l={},m=0;m<c.containingNotebooks.list.length;m++){var n=c.containingNotebooks.list[m];l[n.guid]={joined:n.hasSharedNotebook,name:n.notebookDisplayName,contact:n.contactName}}g.relatedNotes.containingNotebooks=l}g.info=h,f.sfCache[e]=g,extension.setPendingNote(b.pendingNoteKey,f)}i(g)}else log.error(k),j(k)}if(e=c.userId+d,b.pendingNoteKey){if(f=extension.getPendingNote(b.pendingNoteKey)||{},f.sfCache=f.sfCache||{},f.sfCache[e])return void i(f.sfCache[e]);g={}}var l=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],extension.getBaseUrl()),m=c.authenticationToken,n=c.shardId;d===a.ACCOUNT_TYPE_BUSINESS&&(m=c.bizAuthenticationToken,n=c.bizShardId),l.initWithSlot(n,c.userSlot,function(){var a={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:b.text,url:b.url};JsonQueue.handleExpensiveOpRequest({shardId:n,userId:c.userId,type:d},l.client.NoteStoreExtra.getFilingRecommendations,k,m,a)})})}function e(a,b,c){var e=accountManager.currentUserInfo;a.userId!==e.userId?(log.error("Tried to get smartfiling info for account which was not current - not supported!"),c()):d({text:a.text,url:a.url,pendingNoteKey:a.pendingNoteKey},e,a.selectedSubpart).then(function(a){b(a)}).catch(function(a){c(a)})}function f(a,b,c){var d={},e=(accountManager.currentUserInfo,Persistent.getForUser("recentNotebook",a.userId)||{});e=e[a.selectedSubpart],"lastUsed"===options.get("notebookSelection")&&e?d.preferredNotebook=e:"alwaysStartIn"===options.get("notebookSelection")&&options.get("startNotebook")&&(d.preferredNotebook=options.get("startNotebook"));options.get("alwaysTagWith")&&(d.alwaysTags=options.get("alwaysTags").split(/\s*,\s*/)),b(d)}function g(a,b,c){a.userId!==accountManager.currentId&&log.warn("requsted personal notebooks for non-current user");var d=accountManager.findAccount(a.userId),e=d.userInfo.accountType,f=d.userInfo,g=Persistent.getForUser("notebooksCache",f.userId)||{};(!g.version||g.version<v)&&(g={version:v}),g.notebooks=g.notebooks||{},g.notebooks.business=g.notebooks.business||[],g.notebooks.personal=g.notebooks.personal||[],g.notebooks.linked=g.notebooks.linked||[];var l=g.notebooks.personal.length||g.notebooks.business.length;a.cached&&l&&b({personal:g.notebooks.personal,business:g.notebooks.business,linked:g.notebooks.linked}),g.updateCounts=g.updateCounts||{},d.reload().then(function(d){if(d.accountType!==e)return log.warn("Account type was changed, reloading ui"),void c({exception:"Account type was changed",reload:!0});Promise.all([i(d,g.notebooks.personal,g.updateCounts.personal),k(d),j(d,g.notebooks.business,g.updateCounts.business)]).then(function(c){g.updateCounts.personal=c[0].USN,g.updateCounts.business=c[2].USN,g.notebooks.linked=c[1],Object.keys(g.notebooks).forEach(function(a){g.notebooks[a]=h(g.notebooks[a])}),Persistent.setForUser("notebooksCache",d.userId,g),a.cached&&l||b({personal:g.notebooks.personal,business:g.notebooks.business,linked:g.notebooks.linked})}).catch(function(b){a.cached&&l?(log.error("Unable to update notebooks in the background"),log.error(b)):c(b)})})}function h(a){for(var b={},c=[],d=0;d<a.length;d++)b[a[d].guid]||(b[a[d].guid]=!0,c.push(a[d]));return c}function i(a,b,c){c=c||0;var d=storeFactory.createNoteStoreClient(a.urls.noteStoreUrl);return new Promise(function(e,f){function g(a){n(a,"getPersonalNotebooks",f)}function h(a){a.notebooks&&a.notebooks.forEach(function(a){a.shared=a.sharedNotebooks&&a.sharedNotebooks.length,p(a,b)}),a.expungedNotebooks&&a.expungedNotebooks.forEach(function(a){o(a,b)}),c=a.chunkHighUSN,a.updateCount===c?e({notebooks:b,USN:c}):(i[1]=c,d.getFilteredSyncChunk.apply(d,i))}var i=[a.authenticationToken,c,w,new SyncChunkFilter({includeExpunged:!!c,includeNotebooks:!0}),h,g];d.getFilteredSyncChunk.apply(d,i)})}function j(b,c,d){if(d=d||0,!b.bizAuthenticationToken)return Promise.resolve(c);var e=storeFactory.createNoteStoreClient(b.bizUrls.noteStoreUrl);return new Promise(function(f,g){function h(a){n(a,"getBusinessNotebooks",g)}function i(g){g.notebooks&&g.notebooks.forEach(function(d){d.restrictions.noCreateNotes||p({guid:d.guid,name:d.name,noShareNotes:d.restrictions.noShareNotes,owner:d.contact.id!=b.userId?d.contact.name||d.contact.username:null,shared:d.sharedNotebooks&&d.sharedNotebooks.length>1,shardId:b.bizShardId,stack:d.stack,type:a.NOTEBOOK_TYPE_BUSINESS,defaultNotebook:d.recipientSettings.recipientStatus===RecipientStatus.IN_MY_LIST_AND_DEFAULT_NOTEBOOK,published:d.published,sharedNotebooks:d.sharedNotebooks},c)}),g.expungedNotebooks&&g.expungedNotebooks.forEach(function(a){o(a,c)}),d=g.chunkHighUSN,g.updateCount===d?(t?l(t,c,b):k(b).then(function(a){l(t,c,b)}),f({notebooks:c,USN:d})):(j[1]=d,e.getFilteredSyncChunk.apply(e,j))}var j=[b.bizAuthenticationToken,d,w,new SyncChunkFilter({includeExpunged:!!d,includeNotebooks:!0}),i,h];e.getFilteredSyncChunk.apply(e,j)})}function k(b){var d=storeFactory.createNoteStoreClient(b.urls.noteStoreUrl),e={};return a.promisify(d,"listLinkedNotebooks",[b.authenticationToken]).then(function(a){t=a;var d=a.filter(function(a){return a.businessId!==b.businessId&&a.sharedNotebookGlobalId&&a.noteStoreUrl});return Promise.all(d.map(function(a){return a.noteStoreUrl=c(a.noteStoreUrl,b.userSlot),e[a.shardId]||(e[a.shardId]=storeFactory.createNoteStoreClient(a.noteStoreUrl)),q(a,e[a.shardId],b)}))}).then(function(a){return a.filter(function(a){return!!a.guid})})}function l(a,b,c){b.forEach(function(b){if(b.sharedNotebooks){var d=b.sharedNotebooks.find(function(a){return parseInt(c.bizUserId)===a.userId});if(d){var e=a.find(function(a){return d.globalId===a.sharedNotebookGlobalId});e&&e.stack&&(b.stack=e.stack)}}})}function m(a){var b=Browser.i18n.getMessage("Error_Update_Notebooks");return 1!=a.isTrusted&&!1!==navigator.onLine||(b=Browser.i18n.getMessage("Error_Network_Unavailable")),b}function n(a,b,c){log.error("SyncChunkFailure in "+b),log.error(a),a instanceof EDAMUserException&&a.errorCode===EDAMErrorCode.PERMISSION_DENIED&&"Business"===a.parameter&&account.reload().then(function(a){a.bizAuthenticationToken&&log.error("got error that user was not in business, but still got business token here")}),c({exception:m(a)})}function o(a,b){if(b&&b.findIndex){var c=b.findIndex(function(b){return b.guid===a});return c>-1&&(b.splice(c,1),!0)}throw new Error("Error in removeNotebookFromList - list is not an Array, but "+typeof b)}function p(a,b){if(!b||!b.findIndex)throw new Error("Error in addNotebookToList - list is not an Array, but "+typeof b);var c=b.findIndex(function(b){return b.guid===a.guid});c>-1?b[c]=a:b.push(a)}function q(b,c,d){var e="";return a.promisify(c,"authenticateToSharedNotebook",[b.sharedNotebookGlobalId,d.authenticationToken]).then(function(d){if(d.authenticationToken)return e=d,a.promisify(c,"getSharedNotebookByAuth",[e.authenticationToken]);throw new Error("Unable to obtain auth token to notebook "+b.name)}).then(function(b){return a.promisify(c,"getNotebook",[e.authenticationToken,b.notebookGuid])}).then(function(c){var d=c.contact||e.user||e.publicUserInfo;return c.restrictions.noCreateNotes?{}:{globalId:b.sharedNotebookGlobalId,guid:c.guid,name:b.shareName,noShareNotes:c.restrictions.noShareNotes,owner:d.name||d.username,shardId:b.shardId,noteStoreUrl:b.noteStoreUrl,stack:b.stack,type:a.NOTEBOOK_TYPE_LINKED,shared:!0}}).catch(function(a){return log.warn("Unable to access linked notebook "+b.shareName+" ("+b.guid+")\n"+a.toString()+": "+JSON.stringify(a)),{}})}function r(b,c,d){b.userId!==accountManager.currentId&&log.warn("requested tags for non-current user");var e,f,g=accountManager.findAccount(b.userId),h=g.userInfo;b.selectedSubpart===a.ACCOUNT_TYPE_PERSONAL?(e=h.authenticationToken,f=storeFactory.createNoteStoreClient(h.urls.noteStoreUrl)):(e=h.bizAuthenticationToken,f=storeFactory.createNoteStoreClient(h.bizUrls.noteStoreUrl)),a.promisify(f,"listTags",[e]).then(function(a){c(a)}).catch(function(a){log.error("Error listing tags for "+b.userId+" "+b.selectedSubpart),log.error(a),c([])})}function s(b,c,d){function e(a){var b=Browser.i18n.getMessage("Error_Create_Notebook");if(1==a.isTrusted||!1===navigator.onLine)return Browser.i18n.getMessage("Error_Network_Unavailable");switch(a.errorCode){case 2:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_InvalidName")}break;case 5:break;case 10:switch(a.parameter){case"Notebook.name":b=Browser.i18n.getMessage("Error_Create_Notebook_ExistingName")}break;case 6:switch(a.parameter){case"Notebook":b=Browser.i18n.getMessage("Error_Create_Notebook_QuotaReached")}}return b}accountManager.reloadCurrent().then(function(f){var g,h,i,j=b.notebook;j.personalNotebook?(g=storeFactory.createNoteStoreClient(f.urls.noteStoreUrl),h=f.authenticationToken):f.bizAuthenticationToken?(g=storeFactory.createNoteStoreClient(f.bizUrls.noteStoreUrl),h=f.bizAuthenticationToken,i=f.authenticationToken):(log.error("Requested to create business notebook, but there was no business token."),d(Browser.i18n.getMessage("Error_Create_Notebook")));var k=new Notebook({name:j.name});a.promisify(g,"createNotebook",[h,k]).then(function(b){if(b.errorCode||!b.guid)log.error("Error creating notebook "+j.name),log.error(b),d(e(b));else if(j.personalNotebook)c({guid:b.guid,name:b.name,shardId:f.shardId,type:a.NOTEBOOK_TYPE_PERSONAL});else{var g=b.guid,h=new LinkedNotebook({shardId:f.bizShardId,sharedNotebookGlobalId:b.sharedNotebooks[0].globalId,shareName:b.name,username:f.bizUserName}),k=storeFactory.createNoteStoreClient(f.urls.noteStoreUrl);a.promisify(k,"createLinkedNotebook",[i,h]).then(function(b){b.errorCode||!b.guid?(log.error("Error linking business notebook "+j.name),log.error(b),d(e(b))):c({guid:g,name:b.shareName,shardId:f.bizShardId,type:a.NOTEBOOK_TYPE_BUSINESS})}).catch(function(a){log.error(a)})}}).catch(function(a){log.error("Generic error creating notebook "+JSON.stringify(b)),log.error(a),d(e(a))})})}var t,u={},v=2,w=50;return platform.channel.registerHandlers({getNotebooks:g,getTags:r,createNotebook:s,getFilingInfo:f,getSmartFilingInfo:e}),u.getSmartFilingInfo=d,u});