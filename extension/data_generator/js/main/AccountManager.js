/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

!function(){function a(a){this._selectedAccount=null,this._selectedAccountId=null,this._selectedSubpart=GlobalUtils.ACCOUNT_TYPE_PERSONAL,this._accountList=[],this._notify=a.notify,this._bootstrapInfo=a.bootstrapInfo,this.onAccountUpdate=a.onAccountUpdate||function(){}}Object.defineProperty(a.prototype,"currentAccount",{get:function(){return this._selectedAccount}}),Object.defineProperty(a.prototype,"currentId",{get:function(){return this._selectedAccount.userInfo.userId}}),Object.defineProperty(a.prototype,"currentSubpart",{get:function(){return this._selectedSubpart}}),Object.defineProperty(a.prototype,"currentUserInfo",{get:function(){return this._selectedAccount.userInfo}}),Object.defineProperty(a.prototype,"accounts",{get:function(){return this._accountList}}),Object.defineProperty(a.prototype,"authenticatedAccounts",{get:function(){return this._accountList.filter(function(a){return a.userInfo&&a.userInfo.userId})}}),a.prototype.accountHasDefaultNotebook=function(){return this.currentUserInfo.accountType===GlobalUtils.ACCOUNT_TYPE_ONLY_BUSINESS||this._selectedSubpart===GlobalUtils.ACCOUNT_TYPE_PERSONAL},a.prototype.reloadCurrent=function(){return this._selectedAccount.reload()},a.prototype.reloadAccount=function(a){return this.findAccount(a).reload()},a.prototype.findAccount=function(a){for(var b=0;b<this._accountList.length;b++)if(this._accountList[b].userInfo.userId&&this._accountList[b].userInfo.userId===a)return this._accountList[b];return this._accountList[0]},a.prototype._isWrongSubpart=function(a,b){return a.accountType===GlobalUtils.ACCOUNT_TYPE_PERSONAL&&b===GlobalUtils.ACCOUNT_TYPE_BUSINESS||a.isOnlyBusiness&&b===GlobalUtils.ACCOUNT_TYPE_PERSONAL},a.prototype.select=function(a,b){var c=this.findAccount(a);return!c||this._isWrongSubpart(c.userInfo,b)?(log.error("Unable to select account "+a+" "+b),!1):(this._selectedAccount=c,this._selectedAccountId=a,b!==GlobalUtils.ACCOUNT_TYPE_PERSONAL&&b!==GlobalUtils.ACCOUNT_TYPE_BUSINESS&&(b=c.userInfo.isOnlyBusiness?GlobalUtils.ACCOUNT_TYPE_BUSINESS:GlobalUtils.ACCOUNT_TYPE_PERSONAL),this._selectedSubpart=b,!0)},a.prototype.selectInSlot=function(a){var b=this._accountList.find(function(b){return b.slot==a});return b?this.select(b.userInfo.userId):(log.warn("Unable to select account in slot "+a+" - slot is not occupied"),!1)},a.prototype.getUserSlots=function(){var a=this,b="https://"+this._bootstrapInfo.get("serviceHost")+"/GetUsers.action";return new Promise(function(c,d){var e=new XMLHttpRequest;e.open("GET",b,!0),e.onerror=d,e.withCredentials=!0,e.onreadystatechange=function(){if(e.readyState===this.DONE){var b=[];if(200===e.status&&e.responseURL.indexOf("Login.action")<0)try{b=JSON.parse(this.responseText)["clipper-sso"]}catch(a){return void d("Unexpected JSON result in GetUsers: "+this.responseText.substr(0,50))}else 503===e.status&&(a._notify(Browser.i18n.getMessage("Error_Maintenance")),d("503 maintenance"));c(b)}},e.send()})},a.prototype.reload=function(a){var b=this;return this._selectedAccountId=null,this._selectedSubpart=null,this.getUserSlots().then(function(c){return 0===c.length&&c.push(0),b._accountList=c.map(function(a){return new Account({host:b._bootstrapInfo.get("serviceHost"),onUpdated:b.onAccountUpdate,slot:a,notify:b._notify})}),b._selectedAccount||(b._selectedAccount=b._accountList[0]),Promise.all(b._accountList.map(function(b){return b.reload(a)})).then(function(a){var c=a.find(function(a){return a.userId});c&&c.userId&&b.select(c.userId)})})},window.AccountManager=a}();