/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function Extension(){"use strict";function a(){Persistent.get("deviceID")||Persistent.set("deviceID",UUID.generateGuid().slice(0,32))}function b(){tb.currentAccount.isAuthenticated&&(log.log("server keepAlive request"),tb.reloadCurrent())}function c(a){function c(a,b){return Math.floor((b.getTime()-a.getTime())/864e5)}function g(a){null!==rb&&clearTimeout(rb),c(sb,new Date)<3&&(rb=setTimeout(b,9e5)),a&Account.AUTHENTICATED?(eb.updateImageExperiment(),ma(),pb||I(),Browser.setBrowserActionClickHandler(sa)):0===a&&(J(),Browser.setBrowserActionClickHandler(ra)),pb=!0}if(!a)return void log.warn("Version out of date!");mb||(mb=!0,db=new BootstrapInfoStorage,ib=new ExternalMessaging,ib.setMessageHandlers({submitNote:La}),tb=new AccountManager({bootstrapInfo:db,onAccountUpdate:g,notify:y}),window.accountManager=tb,tb.reload().then(function(){options.importUserOptions(),gb=new SSOManager({host:db.get("serviceHost"),viableHosts:db.getAllHosts(),marketingUrl:db.get("marketingUrl"),onSignIn:d,onSignOut:function(){tb.currentAccount.isAuthenticated&&pa({restart:!0})},onSignInDialogDisplay:e,onSignUpDialogDisplay:function(){E({category:"Account",action:"registration",label:"started",data:G()})},onServiceChanged:function(a){M({host:a})}}),fb=new UsageMetricsManager,f(),firstTime.startUp(),firstTime.needToShowIntro()&&firstTime.msgHandlerOnAction(),q(),r(),s(),t(),L({startup:!0}),tb.currentAccount.isAuthenticated&&E({category:"Install or Update",action:"set_user_cd",data:G()}),la(),eb.eligibleForImageExperiment()&&Analytics.trackEvent("split_test","retn_web_saveToEvernoteButton_CC-1897_v1",eb.isInGroupA()?"A_button":"B_control",null,null,null,[{slot:Analytics.CD.EXPORT_TO_DB,value:1}])}),eb=new Experiment({getUserInfo:function(){return tb.currentAccount.isAuthenticated?tb.currentUserInfo:null}}))}function d(a){return sb=new Date,tb.reload(!0).then(function(){if(a.slot&&tb.selectInSlot(a.slot),tb.currentAccount.isAuthenticated&&(I(),a.clipperDialog))return E({category:"Account",action:a.newUser?"registration":"sign_in",label:"completed",data:G()}),Browser.getCurrentTab()}).then(function(a){a&&qb&&a.id===qb&&(qb=null,B({afterAuth:!0},{tab:a}))})}function e(a){E({category:"Account",action:"dialog",label:"opened",startSession:!0}),Browser.sendToTab(a.tab,{name:"checkCookiesAreEnabled"}),Browser.sendToTab(a.tab,{name:"enableKonami"}),options.get("simulateSimplifiedChinese")&&!a.multiAuth&&Browser.sendToTab(a.tab,{name:"enableServiceSwitch",link:"https://"+db.getNextBootstrapData("serviceHost")+"/ClipperLogin.action?wck="+gb.browserID})}function f(){if(!SAFARI){if(jb)return;jb=!0,chrome.contextMenus.removeAll(function(){ob=[],p()})}}function g(a){var b=a.userInfo;if(b&&b.url){if(!b.url.match(/^https?/i))return;if(b.url.match(/^https?:\/\/extensions.apple.com/i))return}tb.accountHasDefaultNotebook()&&tb.currentAccount.isAuthenticated&&(a.contextMenu.appendContextMenuItem(ub.clipPage,Browser.i18n.getMessage("safariContextClipPage"),ub.clipPage),a.contextMenu.appendContextMenuItem(ub.clipScreenshot,Browser.i18n.getMessage("safariContextClipScreenshot"),ub.clipScreenshot),a.userInfo&&a.userInfo.selection&&a.contextMenu.appendContextMenuItem(ub.clipSelection,Browser.i18n.getMessage("safariContextClipSelection"),ub.clipSelection),a.userInfo&&a.userInfo.node&&"img"==a.userInfo.node.toLowerCase()&&a.contextMenu.appendContextMenuItem(ub.clipImage,Browser.i18n.getMessage("safariContextClipImage"),ub.clipImage),a.userInfo&&a.userInfo.pdf&&a.contextMenu.appendContextMenuItem(ub.clipPDF,Browser.i18n.getMessage("safariContextClipPDF"),ub.clipPDF),a.contextMenu.appendContextMenuItem(ub.clipURL,Browser.i18n.getMessage("safariContextClipUrl"),ub.clipURL))}function h(a,b,c){fb.recordActivity(),tb.reloadCurrent().then(function(){if(tb.currentAccount.isAuthenticated)switch(c){case ub.clipPage:i(b);break;case ub.clipScreenshot:j(b);break;case ub.clipSelection:k(a,b);break;case ub.clipImage:l(a,b);break;case ub.clipPDF:m(b);break;case ub.clipURL:n(b)}}).catch(function(){y(Browser.i18n.getMessage("contextMenuPleaseLogin"))})}function i(a){Browser.sendToTab(a,{name:"startSubmission",clipType:ub.clipPage,contextMenu:!0,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})}function j(a){ab({contextMenu:!0},{tab:a},function(b){Browser.sendToTab(a,{name:"startSubmission",clipType:ub.clipScreenshot,contextMenu:!0,screenshotUrl:b,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})})}function k(a,b){Browser.sendToTab(b,{name:"startSubmission",clipType:ub.clipSelection,contextMenu:!0,selectionText:a.selectionText,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})}function l(a,b){Browser.sendToTab(b,{name:"startSubmission",clipType:ub.clipImage,contextMenu:!0,imageUrl:a.srcUrl,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})}function m(a){Browser.sendToTab(a,{name:"startSubmission",clipType:ub.clipPDF,contextMenu:!0,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})}function n(a){Browser.sendToTab(a,{name:"startSubmission",clipType:ub.clipURL,contextMenu:!0,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})}function o(a){var b=tb.accountHasDefaultNotebook()&&tb.currentAccount.isAuthenticated;a&&a.selection&&EDGE?chrome.contextMenus.update(ub.clipSelection,{contexts:["selection","image","link"]}):chrome.contextMenus.update(ub.clipSelection,{contexts:["selection"]}),ob.forEach(function(a){chrome.contextMenus.update(a,{enabled:b})})}function p(){jb=!1;var a=["http://*/*","https://*/*"],b=["http://*/*","https://*/*","chrome-extension://encfpfilknmenlmjemepncnlbbjlabkc/*","chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/*","chrome-extension://mhjfbmdgcfjbbpaeojofohoefgiehjai/*"];(EDGE||FIREFOX)&&(b=a),chrome.contextMenus.create({id:ub.clipPage,title:Browser.i18n.getMessage("contextMenuClipPage"),contexts:["page","image","selection","link"],documentUrlPatterns:FIREFOX?null:a}),ob.push(ub.clipPage),chrome.contextMenus.create({id:ub.clipImage,title:Browser.i18n.getMessage("contextMenuClipImage"),contexts:["image"],targetUrlPatterns:FIREFOX?null:a}),ob.push(ub.clipImage),chrome.contextMenus.create({id:ub.clipSelection,title:Browser.i18n.getMessage("contextMenuClipSelection"),contexts:["selection"],documentUrlPatterns:FIREFOX?null:b}),ob.push(ub.clipSelection),chrome.contextMenus.create({id:ub.clipURL,title:Browser.i18n.getMessage("contextMenuClipUrl"),contexts:["all"],documentUrlPatterns:FIREFOX?null:b}),ob.push(ub.clipURL),EDGE||(chrome.contextMenus.create({id:"screenshot",title:Browser.i18n.getMessage("contextMenuClipScreenshot"),contexts:["page","image","selection"],documentUrlPatterns:FIREFOX?null:a}),ob.push("screenshot"),chrome.contextMenus.create({id:ub.clipPDF,title:Browser.i18n.getMessage("contextMenuClipPDF"),contexts:["all"],documentUrlPatterns:FIREFOX?null:b}),ob.push(ub.clipPDF)),chrome.contextMenus.onClicked.addListener(function(a,b){function c(a){if(z({tab:a})){if(!a||!N(a.url))return!0;y(Browser.i18n.getMessage("illegalUrlClipFailure"))}else y(Browser.i18n.getMessage("popup_couldntStart"));return!1}-1===b.id?Browser.getCurrentTab(function(b){b&&c(b)&&h(a,b,a.menuItemId)}):c(b)&&h(a,b,a.menuItemId)}),o()}function q(){function a(a){SAFARI?(L(),a.target.browserWindow?Browser.sendToTab(a.target,{name:"isExtensionOpen"}):a.target.activeTab&&Browser.sendToTab(a.target.activeTab,{name:"isExtensionOpen"})):(L(),Browser.sendToTab({id:a.tabId},{name:"isExtensionOpen"}))}SAFARI?safari.application.addEventListener("activate",a,!0):(chrome.tabs.onActivated.addListener(a),chrome.windows.onFocusChanged.addListener(function(b){chrome.tabs.query({active:!0,windowId:b},function(b){b&&b.length>0?a({tabId:b[0].id}):log.warn("chrome tabs query did not return a result while changing window focus")})}))}function r(){var a=/^https:\/\/(?:app|www|stage|stage-china)\.(?:evernote|yinxiang)\.com\/subscriptions/;SAFARI?safari.application.addEventListener("beforeNavigate",function(b){a.test(b.target.url)&&ma()}):(chrome.tabs.onUpdated.addListener(function(b,c){c.url&&a.test(c.url)?hb=b:hb===b&&c.url&&ma()}),chrome.tabs.onRemoved.addListener(function(a){hb===a&&(hb=0)}))}function s(){SAFARI||chrome.tabs.onUpdated.addListener(function(a,b,c){b.url&&Browser.sendToTab(c,{name:"urlChanged"})})}function t(){SAFARI?(safari.application.addEventListener("beforeNavigate",function(a){var b=a.target;b.id||(b.id=Math.floor(1e5*Math.random())),u(b.id),Browser.sendToTab(b,{name:"contextIsAlive"})}),safari.application.addEventListener("navigate",function(a){v(a.target.id)})):(chrome.tabs.onUpdated.addListener(function(a,b,c){b.status&&("loading"==b.status?u(a):"complete"==b.status&&v(a,c))}),chrome.tabs.onRemoved.addListener(function(a,b){delete nb[a]}))}function u(a){nb[a]={tabLoaded:!1,invoke:!1}}function v(a,b){var c=nb[a];c&&(c.tabLoaded=!0,c.invoke&&(B(null,c.sender,null),c.invoke=!1),nb[a]=c),Browser.sendToTab(b,{name:"contextIsAlive"})}function w(a){eb.eligibleForImageExperiment()&&eb.imageHoverEnabledInSettings()&&eb.isInGroupA()&&tb.reloadCurrent().then(function(){tb.currentAccount.isAuthenticated&&tb.accountHasDefaultNotebook()&&Browser.sendToTab(a.tab,{name:"enableSaveToEvernote"})})}function x(a,b,c){if(c&&"function"==typeof c&&c(),"coordinator"==a.message.name){nb[b.tab.id]||(nb[b.tab.id]={});var d=nb[b.tab.id];d.coordinatorLoaded=!0,d&&!1===d.tabLoaded&&(d.tabLoaded=!0,!0===d.invoke&&(B(null,d.sender,null),d.invoke=!1),nb[b.tab.id]=d),w(b)}"frame_loader"==a.message.name&&(nb[b.tab.id]||(nb[b.tab.id]={}),nb[b.tab.id].frameLoaderLoaded=!0)}function y(a,b){a&&"string"==typeof a&&(FIREFOX&&chrome.notifications?(chrome.notifications.getAll(function(a){for(var b in a)a.hasOwnProperty(b)&&chrome.notifications.clear(b)}),chrome.notifications.create(null,{type:"basic",title:b||Browser.i18n.getMessage("ExtensionName"),message:a,iconUrl:Browser.extension.getURL("images/ext_icons/web-clipper-40x40.png")},function(a){setTimeout(function(){chrome.notifications.clear(a)},5e3)})):alert(a))}function z(a){var b=nb[a.tab.id];return(!SAFARI||void 0!==a.tab.page)&&(b?b.tabLoaded&&!b.coordinatorLoaded?(log.warn("Unable to toggle clipper, tab loaded, but main coordinator is not"),!1):!(b.frameLoaderLoaded&&!b.coordinatorLoaded)||(log.warn("Unable to toggle clipper, some frames loaded, but main coordinator is not"),!1):(log.warn("Unable to toggle clipper, tab status doesnt exist"),!1))}function A(){eb.eligibleForImageExperiment()&&Analytics.trackEvent("split_test","retn_web_saveToEvernoteButton_CC-1897_v1",eb.isInGroupA()?"A_button":"B_control",null,null,null,[{slot:Analytics.CD.EXPORT_TO_DB,value:1}])}function B(a,b,c){tb.reloadCurrent().then(function(d){var e=a&&a.afterAuth;if(tb.currentAccount.isAuthenticated){var f=nb[b.tab.id];if(A(),b.tab&&b.tab.url&&0===b.tab.url.indexOf("file://"))return void y(Browser.i18n.getMessage("popup_couldntStartLocalFile"));if(N(b.tab.url))return void y(Browser.i18n.getMessage("illegalUrlClipFailure"));if(!z(b)&&!N(b.tab.url))return void(e||y(Browser.i18n.getMessage("popup_couldntStart")));if(EDGE&&/\.pdf$/.test(b.tab.url))return void(e||y(Browser.i18n.getMessage("popup_unsupportedScheme")));if(f&&!1===f.tabLoaded)return f.sender=b,f.invoke=!0,void(nb[b.tab.id]=f);Browser.sendToTab(b.tab,{name:"insertSerializationScripts"}),Browser.sendToTab(b.tab,{name:"toggleCoordinator",bizUser:!!d.businessId,bizComplete:!!d.bizAuthenticationToken,facebookRememberButton:a&&a.facebookRememberButton},function(a){L(),a&&a.message&&log.error("Error toggling coordinator: "+a.message),chrome&&chrome.runtime&&chrome.runtime.lastError&&log.error("Error toggling coordinator: "+chrome.runtime.lastError),e||(a||chrome&&chrome.runtime&&chrome.runtime.lastError)&&(FIREFOX&&chrome.runtime.lastError.message&&chrome.runtime.lastError.message.includes("0x80004005")||y(Browser.i18n.getMessage("popup_couldntStart")))})}else log.error("logged out while toggling clipper.");c&&c()})}function C(a,b,c){}function D(a,b,c,d,e){var f=[],g=Math.max(3-a.length,2),h=[],i=[];a||(a=[]),c||(c=[]);for(var j=0;j<c.length&&!(h.length>=g&&i.length>=g);j++)c[j].shardId=d,c[j].inBusinessNotebook=!0,e[c[j].notebookGuid].joined?h.push(c[j]):(c[j].notebookName=e[c[j].notebookGuid].name,i.push(c[j]));for(var k=Math.min(g,h.length),l=Math.max(g-k,1),m=Math.min(l,i.length),n=h.slice(0,g-m),j=0;j<m;j++)n.push(i[j]);f=a.slice(0,3-n.length);for(var j=0;j<n.length;j++)f.push(n[j]);for(var j=0;j<f.length;j++)f[j].shardId||(f[j].shardId=b);return f}function E(a,b,c){tb.currentAccount.isAuthenticated&&(a.data||(a.data=[]),a.data.push({slot:Analytics.CD.USER_TYPE,value:tb.currentUserInfo.accountType})),Analytics.trackEvent(a.category,a.action,a.label,a.value,a.startSession,a.endSession,a.data),c&&"function"==typeof c&&c()}function F(a,b,c){Analytics.trackTiming(a.category,a.variableName,a.time,a.label),c&&"function"==typeof c&&c()}function G(){var a=[{slot:Analytics.CD.SERVICE_HOST,value:Da("serviceHost")},{slot:Analytics.CD.DEVICE_ID,value:Persistent.get("deviceID")}];return/china/i.test(Da("name"))?a.push({slot:Analytics.CD.GLOBAL_USER_ID,value:"YX"+tb.currentId}):a.push({slot:Analytics.CD.GLOBAL_USER_ID,value:"EN"+tb.currentId}),tb.currentUserInfo.businessId&&a.push({slot:Analytics.CD.BUSINESS_VAULT_ID,value:tb.currentUserInfo.businessId}),a}function H(a,b,c){Browser.setTitle(Browser.i18n.getMessage("webClipperUpdated")),Browser.setIcon("wc6-update"),c&&"function"==typeof c&&c()}function I(a,b,c){if(firstTime.isUpgraded())return void H();Browser.setTitle(Browser.i18n.getMessage("BrowserActionTitle")),Browser.setIcon("web-clipper"),c&&"function"==typeof c&&c()}function J(a,b,c){if(firstTime.isUpgraded())return void H();Browser.setTitle(Browser.i18n.getMessage("signInPrompt")),Browser.setIcon("web-clipper-sign-in"),c&&"function"==typeof c&&c()}function K(a,b,c){Browser.setIcon("close-ext"),c&&"function"==typeof c&&c()}function L(a,b,c){if(firstTime.isUpgraded())return void H();tb.currentAccount.isAuthenticated?a&&a.startup||I():J()}function M(a,b,c){if(db.getLength()>1){if(a.host&&a.host!==db.get("serviceHost"))db.setIndex(db.getHostIndex(a.host));else{var d=db.getIndex();d=(d+1)%2,db.setIndex(d)}gb.host=db.get("serviceHost"),gb.marketingUrl=db.get("marketingUrl"),Persistent.clearForAllUsers("notebooksCache"),tb.reload(),c&&c()}}function N(a){if(!a)return!0;a=(a+"").toLowerCase();for(var b=0;b<vb.length;b++)if(a.startsWith(vb[b]))return!0;return!!a.match(/^https?:\/\/chrome.google.com\/(extensions|webstore)/)}function O(a,b,c){a&&a.refresh?tb.reloadAccount(a.userId).then(function(c){b({userInfo:c,subpart:a.subpart})}).catch(function(a){log.error("Could not get user info"),b(null)}):b({userInfo:tb.findAccount(a.userId).userInfo,subpart:a.subpart})}function P(a,b,c){var a=a||{};a.userId=tb.currentId,a.subpart=tb.currentSubpart,O(a,b,c)}function Q(a,b,c){tb.reloadAccount(a.selectedAccount).then(function(){!tb.currentAccount.isAuthenticated||a.selectedAccount===tb.currentId&&a.selectedSubpart===tb.currentSubpart||E({category:"Account",action:"switch",label:a.selectedSubpart.charAt(0).toUpperCase()+a.selectedSubpart.slice(1)}),tb.select(a.selectedAccount,a.selectedSubpart)?(options.refresh(),b()):c("Account not found")})}function R(a,b,c){var d={};tb.accounts.forEach(function(a){a.userInfo&&a.userInfo.userId&&(d[a.userInfo.userId]=a.userInfo,d[a.userInfo.userId].isAuthenticated=a.isAuthenticated,d[a.userInfo.userId].isAuthenticatedBiz=!a.isBusinessAuthenticationRequired)});var e=tb.currentId,f=tb.currentSubpart,g=options.get("defaultAccount");g&&g.id&&tb.findAccount(g.id)&&(e=g.id,f=g.subpart),b({list:d,selectedAccount:e,selectedSubpart:f})}function S(a,b,c){b(Persistent.get(a.key))}function T(a,b,c){Persistent.set(a.key,a.value),b()}function U(a,b,c){b(options.get(a.key))}function V(a,b,c){SAFARI||o(a),b()}function W(a,b,c){var d=!1;switch(a.name){case"imageExperiment":d=eb.eligibleForImageExperiment()&&eb.isInGroupA()}b(d)}function X(a,b,c){b&&(b.tab||a.toOwnWindow)?Browser.sendToTab(b.tab,{name:"receivePersistentValue",recipient:a.recipient,key:a.key,toOwnWindow:!!a.toOwnWindow,value:Persistent.get(a.key),currentUserId:tb.currentId}):(log.error("No tab in sender!"),log.error(a)),c&&"function"==typeof c&&c()}function Y(a,b,c){Persistent.set(a.key,a.value),c&&"function"==typeof c&&c()}function Z(a,b,c){var d=Persistent.get(a.key);d||(d={}),d[a.userId]=a.value,Persistent.set(a.key,d),c&&"function"==typeof c&&c()}function $(a,b,c){Z({key:a.key,value:a.value,userId:tb.currentId}),c&&"function"==typeof c&&c()}function _(a,b,c){var d=Persistent.get(a.key);d||(d=0),d+=a.delta,Persistent.set(a.key,d),c&&"function"==typeof c&&c()}function aa(a,b,c){Persistent.clearAll(),c&&"function"==typeof c&&c()}function ba(a,b,c){function d(){xb[this.req.url]?(this.resolve(xb[this.req.url]),wb.shift(),wb.length>0&&d.call(wb[0])):this.req.send(this.payload)}var e="";/^get$/i.test(a.method)?a.url+=a.size?(/\?/.test(a.url)?"&":"?")+"size="+a.size:"":a.size&&(e="size="+a.size);var f=new XMLHttpRequest;if(f.url=a.url,f.guid=a.guid,f.method=a.method||"POST",f.open(f.method,a.url),f.responseType="arraybuffer",f.onreadystatechange=function(){if(4===this.readyState){if(200===this.status){for(var a="",e=new Uint8Array(this.response),f=0;f<e.length;f++)a+=String.fromCharCode(e[f]);xb[this.url]="data:"+this.getResponseHeader("Content-type")+";base64,"+btoa(a),b(xb[this.url])}else c("Could not load URL: '"+this.url+"', status code: "+this.status);wb.shift(),wb.length>0&&d.call(wb[0])}},f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),"note"===a.type){var g=a.inBusinessNotebook?tb.currentUserInfo.bizAuthenticationToken:tb.currentUserInfo.authenticationToken;g&&(e+=(e.length?"&":"")+"auth="+g)}wb.push({resolve:b,reject:c,req:f,payload:e}),1===wb.length&&d.call(wb[0])}function ca(a,b,c){ba(a,function(c){Browser.sendToTab(b.tab,{name:"receiveThumbnail",guid:a.guid,datauri:c})},function(){log.warn("Failed to download image: "+a.url)}),c&&"function"==typeof c&&c()}function da(a,b,c){var d=new Image;if(d.onload=function(){var c=document.createElement("canvas");c.width=Math.min(a.cropToWidth,this.width),c.height=Math.min(a.cropToHeight,this.height);var e=c.getContext("2d"),f=Math.min(this.width/c.width,this.height/c.height);e.drawImage(d,(this.width-c.width*f)/2,(this.height-c.height*f)/2,c.width*f,c.height*f,0,0,c.width,c.height),Browser.sendToTab(b.tab,{name:"receiveCroppedImage",datauri:c.toDataURL(),url:a.url,height:c.height,width:c.width})},d.onerror=function(){Browser.sendToTab(b.tab,{name:"receiveCroppedImage",url:a.url})},EDGE||FIREFOX){var e=new XMLHttpRequest;e.responseType="blob";var f=a.url;f.startsWith("//")&&(f="http:"+f),e.open("get",f),e.onload=function(){var a=new FileReader;a.onloadend=function(){d.src=a.result},a.onerror=function(){Browser.sendToTab(b.tab,{name:"receiveCroppedImage",url:f})},a.readAsDataURL(e.response)},e.onerror=function(){Browser.sendToTab(b.tab,{name:"receiveCroppedImage",url:f})},e.send()}else d.src=a.url;c&&"function"==typeof c&&c()}function ea(a,b,c){b(Browser.i18n._getL10nData())}function fa(a,b,c){for(var d in a.options)options.set(d,a.options[d]);c&&c()}function ga(a,b,c){var d={},e=a.type||"all";if("all"!==e)options.clear(a.options[e]),a.options[e].forEach(function(a){d[a]=options.get(a)});else for(var f in a.options)options.clear(a.options[f]),a.options[f].forEach(function(a){d[a]=options.get(a)});"shortcutValues"===a.type&&Browser.sendToTab(b.tab,{name:"optionsShortcutCleared",options:d}),c&&"function"==typeof c&&c()}function ha(a,b,c){a.toOwnWindow&&(a.message.toOwnWindow=!0),b.tab&&Browser.sendToTab(b.tab,a.message),c&&"function"==typeof c&&c()}function ia(a,b,c){a.toOwnWindow?(a.message.toOwnWindow=!0,Browser.sendToTab(a.message)):Browser.getAllTabs(function(b){for(var d=0;d<b.length;d++)Browser.sendToTab(b[d],a.message);c&&c()})}function ja(a,b,c){log.log("Restarting background.html..."),Browser.removeMessageHandlers(),Browser.removeBrowserActionClickHandler(),Browser.getCurrentTab(function(a){a&&-1!==a.url.indexOf(Browser.getExtensionURL("options.html"))&&(log.log("Closing options tab"),SAFARI?safari.application.activeBrowserWindow.activeTab.close():chrome.tabs.remove(a.id,function(){})),window.location.reload()}),c&&"function"==typeof c&&c()}function ka(a,b,c){function d(c){if("simSearch"==a.type)Browser.sendToTab(b.tab,{name:"simSearch_isAuthenticated",auth:c});else if("clipResult"==a.type)Browser.sendToTab(b.tab,{name:"clipResult_isAuthenticated",auth:c});else if("pdfTooltip"==a.type){var d={name:"pdfTooltip_isAuthenticated",auth:c};if(c&&c.userId){var e=Persistent.get(c.userId+"_pdfTooltipShown"),f=Persistent.get("tooltipLastShown");if(f||(f={}),f[c.userId]||(f[c.userId]=0),new Date-0>=f[c.userId]+6048e5?(f[c.userId]=new Date-0,Persistent.set("tooltipLastShown",f),Persistent.set(c.userId+"_pdfTooltipShown",!0),d.pdfTooltipShown=e):d.pdfTooltipShown=!0,d.pdfTooltipShown&&SAFARI&&(d.pdfTooltipShownSafari=!0),d.enablePdfPageButton=options.get("enablePdfPageButton"),a.bootstrapInfo){d.bootstrapInfo={};for(var g in a.bootstrapInfo)d.bootstrapInfo[g]=db.get(g)}Browser.sendToTab(b.tab,d)}}else if("tooltip"==a.type){var d={name:"tooltip_isAuthenticated",auth:c};if(a.bootstrapInfo){d.bootstrapInfo={};for(var g in a.bootstrapInfo)d.bootstrapInfo[g]=db.get(g)}Browser.sendToTab(b.tab,d)}else"ewc"===a.type&&$a(function(a){c&&(c.tempToken=a),Browser.sendToTab(b.tab,{name:"ewc_isAuthenticated",auth:c,baseUrl:ya("secureProto")+Da("serviceHost")})})}!b.tab&&a.toOwnWindow&&log.warn("Request tab was not defined, but request was intended to own window!"),tb.reloadCurrent().then(b&&b.tab?d:c)}function la(){var a=Persistent.get("lastActiveTimes");a||(a={});var b=tb.currentId;b=b||"unauthed",a[b]||(a[b]={time:(new Date).getTime(),count:0}),a.unauthed||(a.unauthed={time:(new Date).getTime(),count:0}),Persistent.set("lastActiveTimes",a)}function ma(a,b,c){var d=tb.currentId;if(d){var e=Persistent.get("basicUpsellTimes")||{};tb.currentUserInfo.basic&&(e[d]||a&&a.forceUpdate)?e[d]=Date.now()+2592e6:delete e[d],Persistent.set("basicUpsellTimes",e),c&&"function"==typeof c&&c()}}function na(a,b,c){tb.reloadCurrent().then(function(){tb.currentAccount.isAuthenticated?"image"===a.clipType?(Analytics.trackEvent("Content Actions","save_to_evernote_clicked","Image"),Browser.getCurrentTab(function(b){Browser.sendToTab(b,{name:"startSubmission",clipType:ub.clipImage,contextMenu:!0,imageUrl:a.imageUrl,smartFilingNotebookAvailable:!1,selectedAccount:tb.currentId,selectedSubpart:tb.currentSubpart})})):"gmail"===a.clipType?(Analytics.trackEvent("Content Actions","save_to_evernote_clicked","Gmail"),Browser.getCurrentTab(function(a){B(null,{tab:a})})):"facebook"===a.clipType&&(Analytics.trackEvent("Content Actions","save_to_evernote_clicked","FB"),Browser.getCurrentTab(function(a){B({facebookRememberButton:!0},{tab:a})})):y(Browser.i18n.getMessage("contextMenuPleaseLogin"))}),c&&"function"==typeof c&&c()}function oa(a,b,c){tb.select(a.userId),pa({},null,c)}function pa(a,b,c){var d=1===tb.authenticatedAccounts.length||a.restart;tb.currentAccount.logout(d).then(function(){if(options.set("defaultAccount","last"),!d&&!a.restart)return tb.reload().then(function(){qa(!1)});qa(!0)}).catch(function(a){log.error(a)}).then(function(){c&&"function"==typeof c&&c()})}function qa(a){gb.dismissSSOPage(),ia({message:{name:"hideOptions",closeClipper:a}}),a&&(Persistent.clear("BootstrapInfoIndex"),Persistent.clear("BootstrapInfo"),setTimeout(ja,300))}function ra(){Browser.getCurrentTab(function(a){qb=a.id,gb.presentSSOPage()})}function sa(a){B(null,{tab:a})}function ta(a,b,c){Browser.sendToTab(b.tab,{name:"getInfo"}),c&&"function"==typeof c&&c()}function ua(a,b,c){function d(){var c;c="Google"!==a.info.searchEngine&&r.bizAuthenticationToken?f():e(),Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",noSimsearchResultsShown:Persistent.get(r.userId+"_noSimsearchResultsShown"),relatedNotes:c,searchEngine:a.info.searchEngine,tokens:{pers:r.authenticationToken,biz:r.bizAuthenticationToken}})}function e(){if(r.bizAuthenticationToken){for(var a=[],b=[],c=0;c<p.length&&!(a.length>=3&&b.length>=3);)p[c].shardId=n.shardId,p[c].inBusinessNotebook=!0,t[p[c].notebookGuid].joined?a.push(p[c]):(p[c].notebookName=t[p[c].notebookGuid].name,p[c].contact=p[c].attributes.lastEditedBy||p[c].attributes.author||t[p[c].notebookGuid].contact,b.push(p[c])),c++;var d=Math.max(3-a.length,1),e=Math.min(d,b.length);p=a.slice(0,3-e);for(var f=0;f<e;f++)p.push(b[f]);q.length>0&&(p[Math.max(0,p.length-1)]=q[0])}var g=[];return o.length>0&&g.push(o),p&&p.length>0&&g.push(p),g}function f(){for(var a=Math.max(3-o.length,2),b=[],c=[],d=0;d<p.length&&!(b.length>=a&&c.length>=a);d++)p[d].shardId=n.shardId,p[d].inBusinessNotebook=!0,t[p[d].notebookGuid].joined?b.push(p[d]):(p[d].notebookName=t[p[d].notebookGuid].name,p[d].contact=p[d].attributes.lastEditedBy||p[d].attributes.author||t[p[d].notebookGuid].contact,c.push(p[d]));for(var e=Math.min(a,b.length),f=Math.max(a-e,1),g=Math.min(f,c.length),h=b.slice(0,a-g),d=0;d<g;d++)h.push(c[d]);for(var i=o.slice(0,3-h.length),d=0;d<h.length;d++)i.push(h[d]);q.length>0&&(i[Math.max(0,i.length-1)]=q[0]);var j=[];return i.length>0&&j.push(i),j}function g(c,e){if(c){if(c.relatedNotes){o=c.relatedNotes.list;for(var f=0;f<o.length;f++)o[f].shardId=m.shardId}else o=[];c.debugInfo&&(s.write("QUERY",a.info.query),s.write("TEXT",a.info.recommendationText),s.write("DEBUG_INFO",c.debugInfo)),(r.bizAuthenticationToken&&p&&q||!r.bizAuthenticationToken)&&d()}else Pa(e,b.tab)}function h(a,c){if(a){if(a.relatedNotes){for(var e=0;e<a.containingNotebooks.list.length;e++){var f=a.containingNotebooks.list[e];t[f.guid]={joined:f.hasSharedNotebook,name:f.notebookDisplayName,contact:f.contactName}}p=a.relatedNotes.list}else p=[];a.debugInfo&&s.write("DEBUG_INFO",a.debugInfo),o&&q&&d()}else Pa(c,b.tab)}function i(a,c){q=[],a?a.experts&&a.experts.list&&a.experts.list.length>0&&q.push({title:a.experts.list[0].name,id:a.experts.list[0].id,type:"expert",role:a.experts.list[0].attributes?a.experts.list[0].attributes.title:null}):Pa(c,b.tab),o&&p&&d()}function j(){var b={includeTitle:!0,includeUpdated:!0,includeAttributes:!0,includeNotebookGuid:!0};return{url:a.info.url,text:a.info.recommendationText,query:a.info.query,relatedNotesResultSpec:b}}function k(){JsonQueue.handleExpensiveOpRequest({shardId:m.shardId,userId:r.userId,type:"pers"},m.client.NoteStoreExtra.getFilingRecommendations,g,r.authenticationToken,j())}function l(){JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,userId:r.userId,type:"biz"},n.client.NoteStoreExtra.getFilingRecommendations,h,r.bizAuthenticationToken,j()),n.client.NoteStore.findRelated(i,r.bizAuthenticationToken,{plainText:a.info.query},{maxExperts:1})}var m,n,o,p,q,r,s,t={};s=SAFARI||EDGE||FIREFOX?new LocalStorageLogWriter("relatedNotesDebugInfo"):new FSLogWriter("relatedNotesDebugInfo"),a.info.recommendationText&&a.info.query&&tb.reloadCurrent().then(function(a){if(a){r=a;var b=Ca();m=new JsonRpc(["NoteStoreExtra.getFilingRecommendations"],b),m.initWithSlot(a.shardId,a.userSlot,k),a.bizAuthenticationToken&&(n=new JsonRpc(["NoteStoreExtra.getFilingRecommendations","NoteStore.findRelated"],b),n.initWithSlot(a.bizShardId,a.userSlot,l))}}),c&&"function"==typeof c&&c()}function va(a,b,c){function d(){this.readyState==this.DONE&&((200==this.status||0===this.status&&a.href.startsWith(Browser.extension.getURL("")))&&(f.responseText=this.responseText),Browser.sendToTab(b.tab,f))}function e(a){log.warn("msgHandlerGetTextResource error"),log.warn(a),Browser.sendToTab(b.tab,f)}var f={name:"content_textResource",href:a.href,moduleName:a.moduleName,responseText:""};try{if(a&&a.href){var g=new XMLHttpRequest;g.open("GET",a.href),g.onreadystatechange=d,g.onerror=e,g.send()}}catch(a){e(a)}c&&"function"==typeof c&&c()}function wa(a,b,c){if(b&&(b.tab||a.toOwnWindow)){options.refresh();var d={name:"config",accountSubPart:tb.currentSubpart};if(a.returnName&&(d.name=a.returnName),a.toOwnWindow&&(d.toOwnWindow=a.toOwnWindow),a.options){d.options={};for(var e in a.options)d.options[e]=options.get(e)}if(a.bootstrapInfo){d.bootstrapInfo={};for(var e in a.bootstrapInfo)db&&(d.bootstrapInfo[e]=db.get(e))}Browser.sendToTab(b.tab,d)}else log.error("No tab in sender!"),log.error(a)}function xa(a,b,c){var d=Persistent.get(Log.localStorageName);Browser.sendToTab(b.tab,{name:"receiveLogs",records:d}),c&&c(d)}function ya(a){return options.get(a)}function za(a,b,c){var d;if("lastUsed"==options.get("defaultClipAction")){var e=Persistent.get("lastUsedAction");d=e||"ARTICLE"}else d=options.get("clipAction");b(d)}function Aa(a,b,c){a.name="receiveOption",a.key=a.option,a.value=options.get(a.key),delete a.option,Browser.sendToTab(b.tab,a),c&&"function"==typeof c&&c()}function Ba(a,b){options.set(a,b)}function Ca(){var a=options.get("secureProto"),b=options.get("overrideServiceURL");return b?(-1===b.indexOf("://")&&(b=a+b),b):a+Da("serviceHost")}function Da(a){return db?db.get(a):""}function Ea(){return db?db.getLength():0}function Fa(a,b,c){Browser.openTab(a.url,c,a.args)}function Ga(a,b,c){Browser.closeTab(b.tab)}function Ha(a,b,c){if(!a.url)throw"Missing URL to create a popup!";var d=a.width||600,e=a.height||600,f=a.url;if(SAFARI){var g=safari.application.openBrowserWindow();g.activeTab.url=f,a.eventListener&&g.addEventListener(a.eventListener.type,a.eventListener.callback),c&&c(g)}else chrome.windows.create({url:f,width:d,height:e,type:a.type||"popup",top:Math.round(Math.max(screen.availHeight-e,0)/2),left:Math.round(Math.max(screen.availWidth-d,0)/2)},function(a){c&&c(a)})}function Ia(a,b,c){try{fb.recordActivity()}catch(a){log.error("Failed to record user activity: "+a.trace||a.stack||JSON.stringify(a))}c&&c()}function Ja(a,b,c){if(!SAFARI&&a.show!=kb)if(kb=a.show,a.show)f();else{chrome.contextMenus.remove(ub.clipPDF);var d=ob.indexOf(ub.clipPDF);d>-1&&ob.splice(d,1)}c&&"function"==typeof c&&c()}function Ka(a,b,c){if(Array.isArray(a.filename))for(var d=0,e=a.filename.length;d<e;d++)Browser.insertCSS(a.filename[d]);else Browser.insertCSS(a.filename);c&&"function"==typeof c&&c()}function La(a,b,c){E({category:"Clip",action:"external"}),tb.reloadCurrent(function(b){if(!tb.currentAccount.isAuthenticated)return c({name:"failure",error:"noAuth"});storeFactory.createNoteStoreClient(b.urls.noteStoreUrl).getDefaultNotebook(b.authenticationToken,function(d){if(!d||!d.guid)return c({name:"failure",error:"noNotebooks",errorJSON:JSON.stringify(d)});var e=function(a){"success"===a.name&&(a.noteUrl=GlobalUtils.getNoteURI(Ca(),a.shardId,a.noteGuid,b.userId)),c(a)},f={noteStoreUrl:b.urls.noteStoreUrl,shardId:b.shardId,token:b.authenticationToken,userId:b.userId,noteSizeMax:b.noteSizeMax};f.username=b.fullName||b.username||"",new Submitter(f,e,!0).createNoteWithThrift(a.title,d.guid,d.name,!1,d.type,a.tags,a.comment,a.url||"","external",a.content,[])},function(a){c({name:"failure",error:"noNotebooks",errorJSON:JSON.stringify(a)})})})}function Ma(a,b,c){function d(a){if("basicUpsell"===ya("simulateClippingError"))return!0;var b=Persistent.get("basicUpsellTimes");return!!(b&&b[a]&&new Date>=b[a]&&tb.currentUserInfo.basic)}function e(a,b){if("hitSpeedbump"===ya("simulateClippingError"))return!0;var c=Persistent.get("shownSpeedbump");if(tb.currentUserInfo.premium&&(!c||!c[a])){var d=tb.currentUserInfo.quota,e=Persistent.get("uploaded"),f=b;if(e&&e[a]&&(f+=e[a]),f>=.5*d)return!0}return!1}function f(a,b){if("nearQuota"===ya("simulateClippingError"))return!0;var c=Persistent.get("shownNearQuotaUpsell");if(!c||!c[a]){var d=tb.currentUserInfo.quota,e=Persistent.get("uploaded"),f=b;if(e&&e[a]&&(f+=e[a]),tb.currentUserInfo.basic){if(f>=d-5242880)return!0}else if(f>=d-262144e3)return!0}return!1}function g(c){var g=tb.currentUserInfo;if("fail"===c.name)c.name="handleFailure",
tb.currentAccount.isAuthenticated&&(Persistent.get(g.userId+"_sawRatingsPrompt")||Persistent.clear(g.userId+"_successfulClipsCount"),Persistent.get(g.userId+"_sawReferralCount")<5&&Persistent.clear(g.userId+"_clipsCount_referral")),Browser.sendToTab(b.tab,c),delete lb[a.pendingNoteKey];else if("success"===c.name){c.name="handleSuccess";var h;Persistent.get(g.userId+"_sawRatingsPrompt")||(h=Persistent.get(g.userId+"_successfulClipsCount"),h||(h=0),Persistent.set(g.userId+"_successfulClipsCount",++h)),Persistent.get(g.userId+"_sawReferralCount")<5&&(h=Persistent.get(g.userId+"_clipsCount_referral"),h||(h=0),Persistent.set(g.userId+"_clipsCount_referral",++h)),e(g.userId,c.noteSize)?c.hitSpeedbump=!0:f(g.userId,c.noteSize)?c.nearQuota=!0:d(g.userId)&&(c.showBasicUpsell=!0),delete c.noteSize,Browser.sendToTab(b.tab,c),delete lb[a.pendingNoteKey]}else"showSyncing"===c.name&&Browser.sendToTab(b.tab,{name:"showSyncing"})}lb[a.pendingNoteKey]||(lb[a.pendingNoteKey]={}),lb[a.pendingNoteKey].note=a,lb[a.pendingNoteKey].originatingTab=b;var h=[];if(a.smartFilingNotebookAvailable){var i="accepted_notebook_suggestion";a.changedSmartFilingNotebook&&(i="changed_from_",a.changedSmartFilingNotebook.from.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?i+="personal":a.changedSmartFilingNotebook.from.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(i+="business"),i+="_to_",a.changedSmartFilingNotebook.to.defaultNotebook?i+="default":a.changedSmartFilingNotebook.to.recentNotebook?i+="last_used":i+="another",i+="_",a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?i+="personal":a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?i+="shared":a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(i+="business"),i+="_notebook"),h.push({slot:Analytics.CD.SMART_FILING,value:i})}h.push({slot:Analytics.CD.TAG,value:a.tags&&a.tags.length>0?"added_tags":"no_tags"}),h.push({slot:Analytics.CD.COMMENTS,value:a.comment&&a.comment.trim()?"added_comments":"no_comments"}),h.push({slot:Analytics.CD.EXPORT_TO_DB,value:1}),h.push({slot:Analytics.CD.HIGHLIGHTS,value:a.content.indexOf("x-evernote:highlighted")>0?"added_highlight":"no_highlight"}),E({category:"Clip",action:a.clipType,label:a.hostname,startSession:!0,data:h}),a.notebook||(a.notebook={type:tb.currentUserInfo.isOnlyBusiness?GlobalUtils.NOTEBOOK_TYPE_BUSINESS:GlobalUtils.NOTEBOOK_TYPE_PERSONAL}),tb.reloadAccount(a.selectedAccount).then(function(c){if(a.error)throw log.error("Serializer error!"),log.error(a.error),b&&b.tab&&b.tab.url&&E({category:"Errors",action:"Serializer: "+a.error.substr(0,200),label:b.tab.url}),{data:{name:"fail",error:a.error}};if(!tb.currentAccount.isAuthenticated)throw void 0;if(-1===[GlobalUtils.NOTEBOOK_TYPE_PERSONAL,GlobalUtils.NOTEBOOK_TYPE_LINKED,GlobalUtils.NOTEBOOK_TYPE_BUSINESS].indexOf(a.notebook.type))throw void 0;return c}).then(function(b){if(a.userSelectedNotebook&&a.notebook.guid){var c=Persistent.getForUser("recentNotebook",b.userId)||{};c[tb.currentSubpart]=a.notebook.guid,Persistent.setForUser("recentNotebook",b.userId,c)}return b}).then(function(b){return a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?new Promise(function(c,d){var e;a.notebook.noteStoreUrl?e=storeFactory.createNoteStoreClient(decodeURIComponent(a.notebook.noteStoreUrl)):(log.error("Sumbission error: request.notebook.noteStoreUrl is empty!"),d("Incorrect notebook url")),e.authenticateToSharedNotebook(a.notebook.globalId,b.authenticationToken,function(a){c([b,a])},d)}):[b,null]}).then(function(c){var d=c[0],e=c[1],f={};switch(a.notebook.type){case GlobalUtils.NOTEBOOK_TYPE_PERSONAL:f.noteStoreUrl=d.urls.noteStoreUrl,f.shardId=d.shardId,f.token=d.authenticationToken,f.userId=d.userId,f.noteSizeMax=d.noteSizeMax;break;case GlobalUtils.NOTEBOOK_TYPE_BUSINESS:f.noteStoreUrl=d.bizUrls.noteStoreUrl,f.shardId=d.bizShardId,f.token=d.bizAuthenticationToken,f.userId=d.bizUserId,f.noteSizeMax=d.bizNoteSizeMax;break;case GlobalUtils.NOTEBOOK_TYPE_LINKED:f.noteStoreUrl=e.urls.noteStoreUrl,f.shardId=e.user.shardId,f.token=e.authenticationToken,f.userId=d.userId,f.noteSizeMax=e.user.accountLimits.noteSizeMax}f.username=d.fullName||d.username||"",new Submitter(f,g,!1,b.tab).createNoteWithThrift(a.title,a.notebook.guid,a.notebook.name,a.notebook.noShareNotes,a.notebook.type,a.tags,a.comment,a.url,a.clipType,a.content,a.resources)}).catch(function(a){var b="object"==typeof a.data&&a.data.name?a.data:{name:"fail",error:a};log.error("Clip aborted! Reason:"),log.error(a),g(b)}),c&&"function"==typeof c&&c()}function Na(){a(),Oa()?Browser.getAcceptLanguages(function(a){new Bootstrapper(a.length?a[0]:null).bootstrap(c,!0)}):c(!0)}function Oa(){var a=Persistent.get("previousLang");return navigator.language!==a?(Persistent.set("previousLang",navigator.language),!0):!Persistent.hasKey("BootstrapInfoIndex")||!Persistent.hasKey("BootstrapInfo")}function Pa(a,b){(/PERMISSION_DENIED/.test(a.trace)||/AUTH_EXPIRED/.test(a.trace))&&/parameter:authenticationToken\)/.test(a.trace)?(pa({authExpired:!0},{tab:b}),b&&Browser.sendToTab(b,{name:"tellUserToLogin"})):log.error(a.trace||a.message||a.stack||a)}function Qa(a,b,c){Browser.sendToTab(b.tab,{name:"receivePersistentFlag",key:a.key,value:Persistent.get(a.key)}),a.set&&Persistent.set(a.key,a.setValue),c&&"function"==typeof c&&c()}function Ra(a,b,c){Persistent.set(a.key,a.value),c&&"function"==typeof c&&c()}function Sa(a,b,c){if(b&&(b.tab||a.toOwnWindow)){for(var d={},e=0;e<a.shortcuts.length;e++)d[a.shortcuts[e]]=options.get(a.shortcuts[e]);Browser.sendToTab(b.tab,{name:"receiveKeyboardShortcuts",keys:d,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}else log.error("No tab in sender!"),log.error(a);c&&"function"==typeof c&&c()}function Ta(a,b,c){tb.reloadCurrent().then(function(b){if(b){var c=(options.get("secureProto"),db.get("serviceHost"),storeFactory.createUtilityClient(b.urls.utilityUrl)),d=new AppFeedback,e=new SupportTicket;e.applicationVersion=Browser.EVERNOTE_VERSION,e.contactEmail=b.email,e.osInfo=a.os,e.deviceInfo=a.browser,e.subject=a.title,e.issueDescription="User agent: "+navigator.userAgent+"\nLanguage: "+navigator.language+"\n\n"+a.details,d.rating=a.rating,d.feedback=e,c.sendAppFeedback(b.authenticationToken,d,function(a){},function(a){log.error("problem sending app feedback: Error code "+a.errorCode+"\n"+a)})}else log.error("logged out while filing a support ticket")}),c&&"function"==typeof c&&c()}function Ua(a,b,c){b&&b.tab&&Browser.sendToTab(b.tab,{name:"receiveSecret",secret:UUID.generateGuid(),recipient:a.recipient}),c&&"function"==typeof c&&c()}function Va(a,b,c){y(a.msg),c&&"function"==typeof c&&c()}function Wa(a,b,c){var d=tb.currentUserInfo,e=d.userId;if(e&&!/china/i.test(db.getName())&&!d.businessId){var f=e%10;if(f>=1&&f<=4){var g=Persistent.get("promo_salesforce");g||(g={}),g[e]||(g[e]=0),g[e]<11&&(g[e]%5==0?(Persistent.set("promo_salesforce",g),Browser.sendToTab(b.tab,{name:"isEligibleForSalesforcePromo",design:f<=2?"A":"B"})):(g[e]++,Persistent.set("promo_salesforce",g)))}}c&&"function"==typeof c&&c()}function Xa(a,b,c){var d=tb.currentId;if(d){var e=Persistent.get("promo_salesforce");e[d]+=a.inc,Persistent.set("promo_salesforce",e)}c&&"function"==typeof c&&c()}function Ya(a,b,c){a.businessSSO?a.userId?(tb.currentId!==a.userId&&tb.select(a.userId),Za(a,b,c)):c("open SignIn page error: no userId specified"):gb.presentSSOPage({multiAuth:a.multiAuth,resolve:b,reject:c})}function Za(a,b,c){var d=/^https:\/\/(?:stage|stage-china|www|app)\.(?:evernote|yinxiang)\.com\/.*business\/BusinessSecurityLogin\.action/,e=Ca()+"/u/"+tb.currentUserInfo.userSlot+"/business/BusinessSecurityLogin.action?clipper=true&wck="+gb.browserID;yb&&yb.close();var f=!1,g=function(){return tb.currentUserInfo.authenticationToken="",tb.reloadCurrent().then(function(a){return!!a.bizAuthenticationToken})},h=function(a,c){if(!a||c)b({success:!1,reason:c});else{var d=tb.currentUserInfo;d.isAuthenticated=tb.currentAccount.isAuthenticated,d.isAuthenticatedBiz=!tb.currentAccount.isBusinessAuthenticationRequired,Persistent.clearForUser("notebooksCache",tb.currentId),b({success:!0,userId:tb.currentId,userInfo:d})}};yb=new BrowserWindow(e,{onClose:function(){f||(f=!0,g().then(h).catch(c))},onNavigate:function(a){d.test(a)&&g().then(function(a){a&&!f&&(f=!0,h(!0),yb.close())})}}),yb.open({width:610,height:550})}function $a(a){tb.reloadCurrent().then(function(b){if(tb.currentAccount.isAuthenticated){storeFactory.createUserStoreClient(b.urls.userStoreUrl).createSessionAuthenticationToken(b.authenticationToken,function(b){a(b)},function(b){b instanceof EDAMUserException?log.error("Error creating temp auth token: "+b.__proto__.name+" ("+b.errorCode+"): "+b.parameter):log.error("Error creating temp auth token"),a(null)})}else log.error("Not logged in while creating temp auth token"),a(null)})}function _a(a,b,c){$a(function(a){Browser.sendToTab(b.tab,{name:"receiveTempToken",tempToken:a})}),c&&"function"==typeof c&&c()}function ab(a,b,c){Browser.captureVisibleTab(b.tab,function(d){if(a.start&&a.end){var e=document.createElement("canvas"),f=new Image;f.onload=function(){var c=this.height/a.screenshotHeight;e.width=c*(a.end.x-a.start.x+1),e.height=c*(a.end.y-a.start.y+1),e.getContext("2d").drawImage(this,c*a.start.x,c*a.start.y,e.width,e.height,0,0,e.width,e.height),Browser.sendToTab(b.tab,{name:"receiveScreenshot",data:e.toDataURL()}),e=null},f.src=d,E({category:"Skitch",action:"take_screenshot",label:"portion"})}else a.contextMenu?c&&c(d):Browser.sendToTab(b.tab,{name:"receiveScreenshot",data:d}),E({category:"Skitch",action:"take_screenshot",label:"whole"})})}function bb(a){return lb[a]}function cb(a,b){lb[a]=b}var db,eb,fb,gb,hb,ib,jb=!1,kb=!0,lb={},mb=!1,nb={},ob=[],pb=!1,qb=null,rb=null,sb=new Date,tb=null;window.addEventListener("offline",function(a){log.log("Went offline.")}),window.addEventListener("online",function(a){if(log.log("Went online."),Object.keys(lb)>0){log.log("processing offline clips");for(var b in lb)Ma(lb[b].note,lb[b].originatingTab)}});var ub={clipPage:"fullPage",clipScreenshot:"screenshot",clipSelection:"selection",clipImage:"image",clipPDF:"pdf",clipURL:"url"};SAFARI&&(safari.application.addEventListener("contextmenu",g,!1),safari.application.addEventListener("command",function(a){h(a.userInfo,safari.application.activeBrowserWindow.activeTab,a.command)},!1));var vb=["https://safari-extensions.apple.com","ms-appx-web://","https://addons.mozilla.org/","chrome://","about:","addons.opera.com","https://addons.opera.com","https://www.msn.com/spartan/ntp"];platform.channel.registerHandlers({downloadImage:ba,getCurrentAccount:P,getAccountById:O,getAccountsData:R,getPersistentValue:S,setPersistentValue:T,getOption:U,setSelectedAccount:Q,updateContextMenu:V,isExperimentActive:W,openSignIn:Ya,getL10nData:ea,getClipAction:za}),Browser.addMessageHandlers({LOGOUT:pa,LogoutUser:oa,main_isAuthenticated:ka,getTempToken:_a,tabStatusReply:C,main_getTextResource:va,simSearch_getNotesRelatedToSearchQuery:ta,simSearch_receivePageInfo:ua,togglePDFContextMenuOption:Ja,getKeyboardShortcuts:Sa,main_setOption:fa,main_clearOptions:ga,main_getConfig:wa,main_getLogs:xa,main_openTab:Fa,main_openWindow:Ha,main_closeSenderWindow:Ga,main_restart:ja,main_recordActivity:Ia,bounce:ha,bounceToAll:ia,insertCSS:Ka,getPersistentFlag:Qa,setPersistentFlag:Ra,getOption:Aa,submitNote:Ma,isAlive:x,toggleClipper:B,trackEvent:E,trackTiming:F,showOpenState:K,showLoggedInState:I,showLoggedInOrOutState:L,getPersistentValue:X,setPersistentValue:Y,setPersistentValueForUser:Z,setPersistentValueForCurrentUser:$,clearPersistent:aa,addToPersistentValue:_,downloadThumbnail:ca,cropImage:da,sendAppFeedback:Ta,generateSecret:Ua,showAlert:Va,determineSalesforcePromoEligibility:Wa,addToSalesforceCounter:Xa,openBusinessSSOPage:Za,captureScreenshot:ab,setBasicUpsellTimes:ma,saveToEvernote:na});var wb=[],xb={},yb=null;this.setOption=Ba,this.getOption=ya,this.getBaseUrl=Ca,this.getBootstrapInfo=Da,this.getBootstrapInfoLength=Ea,this.start=Na,this.startUp=c,this.showLoggedInState=I,this.showLoggedOutState=J,this.msgHandlerIsAuthenticated=ka,this.switchService=M,this.msgHandlerLogout=pa,this.getTempToken=$a,this.msgHandlerOpenTab=Fa,this.msgHandlerSetPersistentValue=Y,this.msgHandlerOpenWindow=Ha,this.msgHandlerRestart=ja,this.msgHandlerRecordActivity=Ia,this.toggleClipper=B,this.openBusinessSSOPage=Za,this.getPendingNote=bb,this.setPendingNote=cb,this.combineRelatedNotes=D,this.trackEvent=E,this.generateUserCustomDimensions=G,Object.preventExtensions(this)}Object.preventExtensions(Extension);