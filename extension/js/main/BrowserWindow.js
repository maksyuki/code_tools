/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

!function(){function a(a,b){if(!a)throw"Missing URL to create a popup!";this._url=a,this._onClose=b.onClose||function(){},this._onOpen=b.onOpen||function(){},this._onNavigate=b.onNavigate||function(){},this._window=null,this._tab=null}Object.defineProperty(a.prototype,"tab",{get:function(){return this._tab}}),Object.defineProperty(a.prototype,"window",{get:function(){return this._window}}),a.prototype.focus=function(){Browser.focusWindow(this._window)},a.prototype.open=function(a){if(this._window)throw new Error("Popup already opened");var b=this,c=a.width||600,d=a.height||600;SAFARI?(this._window=safari.application.openBrowserWindow(),this._window.activeTab.url=this._url,this.subscribeListeners(),b._onOpen()):chrome.windows.create({url:this._url,width:c,height:d,type:a.type||"popup",top:a.top||Math.round(Math.max(screen.availHeight-d,0)/2),left:a.left||Math.round(Math.max(screen.availWidth-c,0)/2)},function(a){b._window=a,FIREFOX?chrome.tabs.query({windowId:a.id}).then(function(a){b._tab=a[0],b.subscribeListeners()}):(b._tab=a.tabs[0],b.subscribeListeners()),b._onOpen()})},a.prototype.close=function(){this._window&&(SAFARI?this._window.close():EDGE?chrome.tabs.remove(this._tab.id):chrome.windows.remove(this._window.id))},a.prototype.subscribeListeners=function(){var a=this,b=function(){a._onClose(),a._window=null,a._tab=null};if(SAFARI)this._window.addEventListener("close",function(){b()}),this._window.addEventListener("navigate",function(b){a._onNavigate(b.target.url)});else{var c=function(d){a._window.id===d&&(chrome.windows.onRemoved.removeListener(c),chrome.tabs.onUpdated.removeListener(e),b())},d=function(c){a._tab&&a._tab.id===c&&(chrome.tabs.onRemoved.removeListener(d),chrome.tabs.onUpdated.removeListener(e),b())},e=function(b,c,d){b===a._tab.id&&"complete"===c.status&&a._onNavigate(d.url||a._tab.url)};chrome.tabs.onUpdated.addListener(e),EDGE?chrome.tabs.onRemoved.addListener(d):chrome.windows.onRemoved.addListener(c)}},window.BrowserWindow=a}(),function(){function a(a,b){if(!a)throw"Missing URL to create a popup!";this._url=a,this._onClose=b.onClose||function(){},this._onOpen=b.onOpen||function(){},this._onNavigate=b.onNavigate||function(){},this._tab=null}Object.defineProperty(a.prototype,"tab",{get:function(){return this._tab}}),Object.defineProperty(a.prototype,"window",{get:function(){return{}}}),a.prototype.focus=function(){this._tab.activate()},a.prototype.open=function(a){if(this._savedTab=safari.application.activeBrowserWindow.activeTab,!SAFARI)throw new Error("Tab wrapper only supports Safari");if(this._tab)throw new Error("Popup already opened");var b=this;this._tab=safari.application.activeBrowserWindow.openTab(),this._tab.url=this._url,this._tab.id||(this._tab.id=Math.floor(1e5*Math.random())),this.subscribeListeners(),b._onOpen()},a.prototype.close=function(){this._tab&&(this._savedTab&&this._savedTab.activate(),this._tab.close())},a.prototype.subscribeListeners=function(){var a=this,b=function(){a._onClose(),a._tab=null};this._tab.addEventListener("close",function(){b()}),this._tab.addEventListener("navigate",function(b){a._onNavigate(b.target.url)})},window.BrowserTab=a}();