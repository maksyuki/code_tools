/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

function ClipResultBackground(){"use strict";function a(a,b,c){var d=document.getElementById("copier");d.value=a.text,d.select(),Browser.sendToTab(b.tab,{name:"sh_urlCopied",copied:document.execCommand("copy",!1,null),toOwnWindow:!0}),c&&"function"==typeof c&&c()}function b(a,b,c){var d=function(a,b){b&&(log.error(b),log.error(b.trace))},e=accountManager.currentUserInfo;storeFactory.createNoteStoreClient(e.urls.noteStoreUrl).emailNote(a.token,new NoteEmailParameters({guid:a.noteGuid,toAddresses:a.recipients,message:a.message}),d),c&&"function"==typeof c&&c()}function c(a,b,c){function d(c){for(var d=[],e=0;e<c.length;e++)c[e].type===ContactType.EMAIL&&d.push({name:c[e].name,email:c[e].id});Browser.sendToTab(b.tab,{name:"sh_receiveContacts",contacts:d,count:a.count,toOwnWindow:!0})}function e(a){log.error(a)}accountManager.reloadCurrent().then(function(b){accountManager.currentAccount.isAuthenticated?storeFactory.createNoteStoreClient(accountManager.currentUserInfo.urls.noteStoreUrl).findContacts(b.authenticationToken,new ContactsQuery({maxEntries:5,prefix:a.prefix}),d,e):log.error("not logged in while finding contacts")}),c&&"function"==typeof c&&c()}function d(a,b,c){sidebarBackground.getSmartFilingInfo({pendingNoteKey:a.pendingNoteKey,text:a.recText,url:a.url},accountManager.currentUserInfo,accountManager.currentSubpart).then(function(a){var c=extension.combineRelatedNotes(a.relatedNotes,accountManager.currentSubpart===GlobalUtils.ACCOUNT_TYPE_PERSONAL?accountManager.currentUserInfo.shardId:accountManager.currentUserInfo.bizShardId,[],"",a.relatedNotes.containingNotebooks)||[];Browser.sendToTab(b.tab,{name:"cr_receiveRelatedNotes",relatedNotes:c})}).catch(function(a){log.error(a),Browser.sendToTab(b.tab,{name:"cr_receiveRelatedNotes",relatedNotes:[]})}),c&&"function"==typeof c&&c()}function e(a,b,c){function d(a,c){a.name="cr_receiveSameSiteNotes",Browser.sendToTab(b.tab,a)}function e(a){l=a,(i.bizAuthenticationToken&&m||!i.bizAuthenticationToken)&&d(g())}function f(a){m=a,l&&d(g())}function g(){for(var a=0;a<l.notes.list.length;a++)l.notes.list[a].shardId=j.shardId;if(i.bizAuthenticationToken){for(var a=0;a<m.notes.list.length;a++)m.notes.list[a].shardId=k.shardId,m.notes.list[a].inBusinessNotebook=!0,l.notes.list.push(m.notes.list[a]);l.notes.list.sort(function(a,b){return b.updated-a.updated})}return l}function h(){j.client.NoteStoreExtra.findNotesWithSnippet(e,i.authenticationToken,o,0,p,n),i.bizAuthenticationToken&&k.client.NoteStoreExtra.findNotesWithSnippet(f,i.bizAuthenticationToken,o,0,p,n)}var i,j,k,l,m,n=a.resultSpec,o=a.noteFilter,p=10;accountManager.reloadCurrent().then(function(a){if(i=a,accountManager.currentAccount.isAuthenticated){var b=extension.getBaseUrl();j=new JsonRpc(["NoteStoreExtra.findNotesWithSnippet"],b),j.initWithSlot(a.shardId,a.userSlot,function(){a.bizShardId?(k=new JsonRpc(["NoteStoreExtra.findNotesWithSnippet"],b),k.initWithSlot(a.bizShardId,a.userSlot,h)):h()})}}),c&&c()}function f(a,b,c){var d=accountManager.currentSubpart===GlobalUtils.ACCOUNT_TYPE_BUSINESS;a.name="cr_initialize",a.baseUrl=options.get("secureProto")+extension.getBootstrapInfo("serviceHost"),a.locale=extension.getBootstrapInfo("name"),a.afterClip=options.get("afterClip"),a.basic=accountManager.currentUserInfo.basic,a.plus=accountManager.currentUserInfo.plus,a.premium=accountManager.currentUserInfo.premium||accountManager.currentUserInfo.isOnlyBusiness,a.noteSizeMax=d?accountManager.currentUserInfo.bizNoteSizeMax:accountManager.currentUserInfo.noteSizeMax,a.quota=d?accountManager.currentUserInfo.bizQuota:accountManager.currentUserInfo.quota,a.userNoteCountMax=d?accountManager.currentUserInfo.bizUserNoteCountMax:accountManager.currentUserInfo.userNoteCountMax,a.sharingOptionsEnabled={facebook:extension.getBootstrapInfo("enableFacebookSharing"),linkedin:extension.getBootstrapInfo("enableLinkedInSharing"),singleNote:extension.getBootstrapInfo("enableSingleNoteSharing"),twitter:extension.getBootstrapInfo("enableTwitterSharing")},Browser.sendToTab(b.tab,a),c&&"function"==typeof c&&c()}function g(a,b,c){function d(a){}function e(a){log.error(a)}var f=new NoteAttributes({source:"web.clip",sourceURL:a.sourceURL,reminderOrder:a.reminderOrder});a.reminderTime&&(f.reminderTime=a.reminderTime),storeFactory.createNoteStoreClient(a.noteStoreUrl).updateNote(a.token,new Note({guid:a.noteGuid,title:a.title,attributes:f}),d,e),c&&"function"==typeof c&&c()}function h(b,c,d){function e(d){var e=options.get("secureProto")+extension.getBootstrapInfo("serviceHost")+"/shard/"+g.shardId+"/sh/"+b.guid+"/"+d;Browser.sendToTab(c.tab,{name:"sh_complete",url:e,toOwnWindow:!0}),"url"===b.shareType&&a({text:e},c)}function f(a){log.error(a)}var g=accountManager.currentUserInfo;storeFactory.createNoteStoreClient(b.noteStoreUrl).shareNote(b.token,b.guid,e,f),d&&"function"==typeof d&&d()}function i(a,b,c){function d(a,b,c){if(SAFARI){"https://www.facebook.com/dialog/return/close?#_=_"===a.target.url&&(safari.application.removeEventListener("navigate",d),Browser.closeWindow(j.facebook))}else b&&"loading"===b.status&&"https://www.facebook.com/dialog/return/close?#_=_"===b.url&&(Browser.closeWindow(j.facebook),chrome.tabs.onUpdated.removeListener(d))}function e(a,b){function c(a){return!(Object.keys(a).length>0)}if(SAFARI){var f=a.target;for(var g in j)j.hasOwnProperty(g)&&j[g]===f&&(delete j[g],c(j)&&safari.application.addEventListener("navigate",d))}else for(var g in j)j.hasOwnProperty(g)&&j[g].id===b.windowId&&(delete j[g],c(j)&&(chrome.tabs.onRemoved.removeListener(e),chrome.tabs.onUpdated.hasListener(d)&&chrome.tabs.onUpdated.removeListener(d)))}var f=a.shareType,g=a.url,h=a.windowInfo;SAFARI||chrome.tabs.onRemoved.hasListener(e)||chrome.tabs.onRemoved.addListener(e),"facebook"===f&&(SAFARI?safari.application.addEventListener("navigate",d):chrome.tabs.onUpdated.hasListener(d)||chrome.tabs.onUpdated.addListener(d)),j[f]?Browser.focusWindow(j[f]):extension.msgHandlerOpenWindow({url:g,width:h.width,height:h.height,top:h.top,left:h.left,eventListener:SAFARI?{type:"close",callback:e}:null,type:"popup"},null,function(a){j[f]=a}),c&&"function"==typeof c&&c()}var j={};Browser.addMessageHandlers({copyText:a,emailNote:b,findContacts:c,getRelatedNotes:d,getSameSiteNotes:e,initializeClipResult:f,setReminder:g,shareNote:h,openShareNoteWindow:i}),Object.preventExtensions(this)}Object.preventExtensions(ClipResultBackground);