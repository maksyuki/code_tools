/*! Copyright 2009-2017 Evernote Corporation. All rights reserved. */

!function(){function a(a){this._onSignIn=a&&"function"==typeof a.onSignIn?a.onSignIn:null,this._onSignOut=a&&"function"==typeof a.onSignOut?a.onSignOut:null,this._onSignInDialogDisplay=a&&"function"==typeof a.onSignInDialogDisplay?a.onSignInDialogDisplay:null,this._onSignUpDialogDisplay=a&&"function"==typeof a.onSignUpDialogDisplay?a.onSignUpDialogDisplay:null,this._onServiceChanged=a&&"function"==typeof a.onServiceChanged?a.onServiceChanged:null,this.marketingUrl=a.marketingUrl||"",this._presentedDialog=null,this._waitingForDialog=!1,this.host=a.host||"",this._signInUrls=(a.viableHosts||[this.host]).map(function(a){return"https://"+a+"/ClipperLogin.action"}),this._signUpUrls=(a.viableHosts||[this.host]).map(function(a){return"https://"+a+"/Registration.action"}),this._initObserver()}var b=function(a){var b={};return(a.split("?")[1]||"").split("&").forEach(function(a){var c=a.split("=");b[c[0]]=c[1]}),b},c=function(a){return"true"===b(a).canClose},d=function(a,b){for(var c=0;c<b.length;c++)if(a.startsWith(b[c]))return!0;return!1};window.SSOManager=a,Object.defineProperty(a.prototype,"host",{get:function(){return this._host},set:function(a){this._host=a,this._generateUrls()}}),Object.defineProperty(a.prototype,"browserID",{get:function(){var a="clipper_chr";return SAFARI?a="clipper_saf":OPERA?a="clipper_op":YANDEX?a="clipper_yan":EDGE?a="clipper_edg":FIREFOX&&(a="clipper_ff"),a}}),a.prototype._initObserver=function(){if(!this._host)return log.error("Missing a host to observe SSO page.");var a=this,b=function(b,c){var d=b.url||"",e=void 0===c||"loading"===c;a._isPresentedDialog(b)||(e&&d.startsWith(a._urls.webSignedIn)?(a.dismissSSOPage(),a._onSignIn({newUser:d.indexOf("newReg=true")>-1,clipperDialog:!1})):e&&(d.startsWith(a.marketingUrl)||d.startsWith("https://"+a._host))&&a._urls.signedOutRegex.test(d)&&a._onSignOut())};SAFARI?safari.application.addEventListener("navigate",function(a){b(a.target)}):chrome.tabs.onUpdated.addListener(function(a,c,d){b(d,c.status||"")})},a.prototype._switchHost=function(b){var c=b.match(a.HOST_REGEX)[1];this.host!==c&&this._onServiceChanged(c)},a.prototype._generateUrls=function(){var a="https://"+this._host,b=a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");this._urls={signInForm:a+"/ClipperLogin.action",webSignedIn:a+"/Home.action",webSignedInRegex:new RegExp(b+"(\\/u\\/\\d+)?\\/Home\\.action","i"),signedOutRegex:/(?:logged-out|LoggedOut\.action)/i}},a.prototype._isPresentedDialog=function(a){return!!this._presentedDialog&&(SAFARI?a.id===this._presentedDialog.tab.id:a.windowId===this._presentedDialog.window.id)},a.prototype.presentSSOPage=function(a){a=a||{};var b=this;if(!this._host)return a.reject&&a.reject(),log.error("Missing a host to open SSO page.");if(this._waitingForDialog)return void(a.reject&&a.reject());if(this._presentedDialog)this._presentedDialog.focus();else{this._waitingForDialog=!0;var e=b._urls.signInForm+"?wck="+b.browserID+(a.multiAuth?"&multiAuth=true":""),f={onOpen:function(){b._waitingForDialog=!1},onClose:function(){b._presentedDialog=null},onNavigate:function(e){if(d(e,b._signInUrls))b._switchHost(e),b._onSignInDialogDisplay({tab:b._presentedDialog.tab,multiAuth:a.multiAuth});else if(d(e,b._signUpUrls))b._onSignUpDialogDisplay({tab:b._presentedDialog.tab,multiAuth:a.multiAuth});else if(c(e)||e.startsWith(b._urls.webSignedIn)||b._urls.webSignedInRegex.test(e)){b._switchHost(e),b.dismissSSOPage();var f=e.match(/\/u\/(\d+)\//i),g=f&&f.length?f[1]:null;b._onSignIn({newUser:e.indexOf("newReg=true")>-1,clipperDialog:!0,slot:g}).then(function(){a.resolve&&a.resolve()})}}};this._presentedDialog=SAFARI?new BrowserTab(e,f):new BrowserWindow(e,f),this._presentedDialog.open({width:610,height:730})}},a.prototype.dismissSSOPage=function(){this._presentedDialog&&this._presentedDialog.close()},a.SIGNIN_PRESENTED=1,a.SIGNED_IN=2,a.SIGNED_OUT=4,a.MANUAL_SIGNIN=8,a.MANUAL_SIGNUP=16,a.SIGNUP_PRESENTED=32,a.HOST_REGEX=/https?:\/\/([a-z0-9-.]*)\//i,a.getStateString=function(b){var c=[];return b&a.SIGNIN_PRESENTED&&c.push("SIGNIN_PRESENTED"),b&a.SIGNUP_PRESENTED&&c.push("SIGNUP_PRESENTED"),b&a.SIGNED_IN&&c.push("SIGNED_IN"),b&a.SIGNED_OUT&&c.push("SIGNED_OUT"),b&a.MANUAL_SIGNIN&&c.push("MANUAL_SIGNIN"),b&a.MANUAL_SIGNUP&&c.push("MANUAL_SIGNUP"),c.join(" ")}}();